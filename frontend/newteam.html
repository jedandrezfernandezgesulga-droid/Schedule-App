<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alpha Squad — Team Manager</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root{ 
    --text:#ffffff; 
    --muted:rgba(255, 255, 255, 0.6); 
    --accent:#38bdf8; /* Sky Blue */
    --accent-purple:#c084fc; /* Purple */
    --success:#4ade80;
    --danger:#fb7185;
    --warning:#facc15;
    
    --glass: rgba(255, 255, 255, 0.05);
    --glass-hover: rgba(255, 255, 255, 0.08);
    --glass-input: rgba(0, 0, 0, 0.3);
    --border: rgba(255, 255, 255, 0.08);
    --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
    
    --radius: 16px; 
  }
  
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
  
  body {
    background: linear-gradient(135deg, #020617 0%, #111030 50%, #2e1065 100%);
    background-attachment: fixed;
    color: var(--text);
    height: 100vh;
    overflow: hidden; 
  }

  /* Custom Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

  .app-layout {
    display: grid;
    grid-template-rows: auto 1fr;
    height: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 24px;
  }

  /* HEADER */
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 0;
    margin-bottom: 12px;
  }
  
  .brand { display: flex; align-items: center; gap: 14px; }
  .logo-img { 
    width: 42px; height: 42px; 
    border-radius: 10px; 
    object-fit: contain; 
    box-shadow: 0 0 15px rgba(56, 189, 248, 0.5);
  }
  .brand h1 { font-size: 20px; font-weight: 800; letter-spacing: -0.02em; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
  .brand p { font-size: 13px; color: var(--muted); }

  .actions { display: flex; gap: 12px; }

  /* BUTTONS */
  .btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 10px 18px; border-radius: 10px;
    font-size: 13px; font-weight: 600;
    cursor: pointer; transition: all 0.2s;
    border: 1px solid transparent;
  }
  
  .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text); }
  .btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
  
  .btn-primary { 
    background: white; color: #000; 
    box-shadow: 0 4px 15px rgba(255,255,255,0.2);
    border: none;
  }
  .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

  .btn-ghost { background: transparent; color: var(--muted); }
  .btn-ghost:hover { color: white; background: rgba(255,255,255,0.05); }

  /* MAIN GRID */
  .grid-container {
    display: grid;
    grid-template-columns: 1fr 440px;
    gap: 30px;
    padding-bottom: 30px;
    overflow: hidden;
    height: 100%;
  }

  /* PANELS (Glass Style) */
  .panel {
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    box-shadow: var(--shadow);
  }
  
  .panel-header {
    padding: 18px 24px;
    border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(255,255,255,0.02);
  }
  .panel-title { font-size: 15px; font-weight: 700; color: white; display: flex; gap: 10px; align-items: center; }

  /* INSIGHTS WIDGET (Interactive) */
  .insights {
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;
    margin-bottom: 16px;
  }
  .insight-card {
    background: rgba(0,0,0,0.2); border: 1px solid var(--border);
    padding: 12px; border-radius: 10px; transition: 0.2s;
    cursor: pointer; position: relative; overflow: hidden;
  }
  .insight-card:hover { border-color: var(--accent); background: rgba(56, 189, 248, 0.05); transform: translateY(-2px); }
  .insight-card:active { transform: translateY(0); }
  
  .insight-label { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; letter-spacing: 0.5px; }
  .insight-val { font-size: 18px; font-weight: 700; color: white; display: flex; align-items: center; gap: 6px; }
  .insight-icon-corner { position: absolute; top: 8px; right: 8px; opacity: 0.3; }

  /* MEMBER LIST */
  .list-container { flex: 1; overflow-y: auto; padding: 16px; }
  .search-bar { padding: 16px 24px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); z-index: 10; }
  .search-input {
    width: 100%; background: var(--glass-input); border: 1px solid var(--border);
    padding: 12px 16px 12px 40px; border-radius: 10px; color: white; font-size: 14px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: 12px center;
    transition: 0.2s;
  }
  .search-input:focus { outline: none; border-color: var(--accent); background: rgba(0,0,0,0.4); }

  .member-card {
    padding: 14px; border-radius: 12px;
    background: transparent; border: 1px solid transparent;
    transition: 0.2s; margin-bottom: 6px; cursor: pointer;
  }
  .member-card:hover { background: var(--glass-hover); border-color: var(--border); transform: translateX(4px); }
  .member-card-header { display: flex; align-items: center; gap: 16px; }
  
  /* Member Expanded View */
  .member-week-view {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      display: none;
      animation: fadeIn 0.2s ease;
  }
  .member-card.expanded .member-week-view { display: block; }
  .member-card.expanded { background: rgba(255,255,255,0.03); border-color: var(--border); }
  
  .week-row {
      display: flex; justify-content: space-between;
      font-size: 11px; color: var(--muted);
      padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.02);
  }
  .week-row:last-child { border-bottom: none; }
  .week-day { width: 40px; font-weight: 700; text-transform: uppercase; color: var(--accent-purple); opacity: 0.8; }
  .week-time { color: white; text-align: right; font-family: monospace; font-size: 11px; }

  .avatar {
    width: 42px; height: 42px; border-radius: 50%;
    background: rgba(255,255,255,0.05);
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 14px; color: white; border: 1px solid var(--border);
    position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }
  .status-dot {
    width: 10px; height: 10px; background: var(--success); border-radius: 50%;
    position: absolute; bottom: 0; right: 0; border: 2px solid #1e1b4b; /* Match bg approx */
    box-shadow: 0 0 5px var(--success);
  }
  .status-dot.busy { background: var(--danger); box-shadow: 0 0 5px var(--danger); }
  .status-dot.pending { background: var(--warning); box-shadow: 0 0 5px var(--warning); border-color: #1e1b4b; }
  .status-dot.offline { background: var(--muted); box-shadow: none; border-color: #1e1b4b; }
  
  .member-info { flex: 1; }
  .member-name { font-weight: 600; font-size: 14px; color: #fff; }
  .member-sub { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 8px; margin-top: 2px; }
  
  /* BADGES */
  .badge { font-size: 10px; padding: 2px 8px; border-radius: 20px; font-weight: 600; background: rgba(255,255,255,0.05); color: var(--muted); border: 1px solid rgba(255,255,255,0.05); }
  .badge.avail { color: var(--success); background: rgba(74, 222, 128, 0.1); border-color: rgba(74, 222, 128, 0.2); }
  .badge.off { color: var(--danger); background: rgba(251, 113, 133, 0.1); border-color: rgba(251, 113, 133, 0.2); }
  .badge.pending { color: var(--warning); background: rgba(250, 204, 21, 0.1); border-color: rgba(250, 204, 21, 0.2); }

  /* ROSTER DIVIDER */
  .roster-divider {
      margin: 16px 0 8px 0;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      font-size: 11px; font-weight: 700; color: var(--muted);
      text-transform: uppercase; letter-spacing: 1px;
      padding-left: 8px;
  }

  /* RIGHT SIDE - FORM & EVENTS */
  .form-section { padding: 20px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.02); }
  .input-group { margin-bottom: 16px; }
  .label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); margin-bottom: 6px; display: block; font-weight: 700; }
  
  .form-control {
    width: 100%; background: var(--glass-input); border: 1px solid var(--border);
    padding: 12px; border-radius: 8px; color: white; font-size: 13px; outline: none; transition: 0.2s;
  }
  .form-control:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.1); }
  
  .flex-row { display: flex; gap: 12px; }
  .flex-1 { flex: 1; }

  /* Manual Select Dropdown */
  .manual-select-container { 
    background: rgba(0,0,0,0.4); border: 1px solid var(--border); border-radius: 8px; 
    max-height: 150px; overflow-y: auto; margin-bottom: 12px;
  }
  
  .manual-option { padding: 8px 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; color: var(--muted); border-bottom: 1px solid rgba(255,255,255,0.02); }
  .manual-option:hover { background: rgba(255,255,255,0.05); color: white; }
  .manual-option.selected { color: var(--accent); background: rgba(56, 189, 248, 0.1); }

  /* TABS */
  .list-tabs { display: flex; padding: 0 24px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
  .tab-btn { 
    padding: 14px 0; margin-right: 20px; font-size: 11px; font-weight: 700; 
    color: var(--muted); text-transform: uppercase; cursor: pointer; letter-spacing: 1px;
    border-bottom: 2px solid transparent; transition: 0.2s; 
  }
  .tab-btn.active { color: white; border-bottom-color: var(--accent); }
  .tab-btn:hover { color: white; }

  .event-list { padding: 20px; overflow-y: auto; flex: 1; }
  
  /* Expandable Event Card */
  .event-card {
    background: rgba(255,255,255,0.03); 
    border: 1px solid var(--border); border-radius: 12px;
    padding: 16px; margin-bottom: 12px; transition: 0.2s;
    position: relative; cursor: pointer;
  }
  .event-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.2); background: rgba(255,255,255,0.06); }
  
  /* Status Borders */
  .event-card.assigned { border-left: 3px solid var(--success); }
  .event-card.draft { border-left: 3px solid var(--muted); border-style: dashed; }
  .event-card.pending { border-left: 3px solid var(--warning); }
  
  .event-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; pointer-events: none; }
  .event-title { font-weight: 700; font-size: 15px; color: white; }
  .event-loc { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 4px; margin-top: 4px; }
  
  .team-avatars { display: flex; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); align-items: center; pointer-events: none; }
  .mini-avi {
    width: 28px; height: 28px; border-radius: 50%; background: #27272a;
    border: 2px solid var(--border); margin-right: -10px; font-size: 10px;
    display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;
  }
  .mini-avi.count { background: #27272a; margin-right: 0; margin-left: 6px; z-index: 2; width: auto; padding: 0 8px; border-radius: 12px; }

  /* Expanded Details */
  .event-details { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); animation: fadeIn 0.3s ease; }
  .event-card.expanded .event-details { display: block; }
  .detail-label { font-size: 11px; text-transform: uppercase; color: var(--muted); margin-bottom: 4px; font-weight: 600; }
  .assigned-list { display: flex; flex-wrap: wrap; gap: 6px; }
  .assigned-tag { font-size: 11px; background: rgba(56, 189, 248, 0.1); color: var(--accent); padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(56, 189, 248, 0.2); }

  /* Draft/Pending Badge */
  .status-badge-inline { font-size: 10px; padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border); color: var(--muted); margin-left: 8px; display: inline-block; vertical-align: middle; background: rgba(255,255,255,0.05); }

  @keyframes fadeIn { from{ opacity:0; transform:translateY(-5px); } to{ opacity:1; transform:translateY(0); } }

  /* MODAL */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center; z-index: 50;
    opacity: 0; pointer-events: none; transition: 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: auto; }
  .modal {
    width: 500px; background: #121215; border: 1px solid var(--border);
    border-radius: 24px; padding: 24px; transform: scale(0.95); transition: 0.2s;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
    background: linear-gradient(145deg, rgba(30,27,75,0.9), rgba(18,18,21,0.95));
  }
  .modal-overlay.open .modal { transform: scale(1); }

  /* INSIGHTS MODAL LIST */
  .insight-list { max-height: 300px; overflow-y: auto; margin-top: 16px; }
  .insight-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--muted); font-size: 13px; align-items: center; }
  .insight-item:last-child { border-bottom: none; }
  .insight-item b { color: white; }

  /* Toast */
  .toast {
    position: fixed; bottom: 30px; right: 30px;
    padding: 12px 24px; border-radius: 10px; background: white; color: black;
    font-weight: 600; transform: translateY(100px); opacity: 0; transition: 0.3s;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100;
  }
  .toast.show { transform: translateY(0); opacity: 1; }

  @media(max-width: 900px) {
    .grid-container { grid-template-columns: 1fr; overflow-y: auto; }
    .panel { max-height: none; }
  }
</style>
</head>
<body>

<div class="app-layout">
  <!-- HEADER -->
  <header>
    <div class="brand">
      <img src="LOGO.png" alt="Logo" class="logo-img">
      <div>
        <h1>Alpha Squad</h1>
        <p>Team Management</p>
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-secondary" onclick="window.location.href='user_home.html'">
        <i data-lucide="arrow-left" width="16"></i> Back to Hub
      </button>
      
      <button class="btn btn-secondary" id="refreshBtn" title="Sync Data">
        <i data-lucide="refresh-cw" width="16"></i>
      </button>
      
      <button class="btn btn-primary" id="openAddMember">
        <i data-lucide="plus" width="16"></i> Add Member
      </button>
    </div>
  </header>

  <!-- GRID -->
  <main class="grid-container">
    
    <!-- LEFT: MEMBERS -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <i data-lucide="users" size="18" style="color:var(--accent);"></i> Roster
        </div>
        <span class="badge" id="memberCount">0 Members</span>
      </div>

      <!-- Interactive Insights -->
      <div style="padding: 16px 24px 0 24px;">
          <div class="insights">
              <div class="insight-card" onclick="openInsightModal('available')">
                  <div class="insight-icon-corner"><i data-lucide="check-circle" width="16"></i></div>
                  <div class="insight-label" style="color:var(--success)">Available Today</div>
                  <div class="insight-val" id="availToday">0</div>
              </div>
              <div class="insight-card" onclick="openInsightModal('unavailable')">
                  <div class="insight-icon-corner"><i data-lucide="x-circle" width="16"></i></div>
                  <div class="insight-label" style="color:var(--danger)">Not Available</div>
                  <div class="insight-val" id="notAvailToday">0</div>
              </div>
              <div class="insight-card" onclick="openInsightModal('vacant')">
                  <div class="insight-icon-corner"><i data-lucide="bar-chart-2" width="16"></i></div>
                  <div class="insight-label" style="color:var(--accent)">Most Vacant</div>
                  <div class="insight-val" style="font-size:14px;" id="mostVacant">--</div>
              </div>
          </div>
      </div>
      
      <div class="search-bar">
        <input type="text" id="search" class="search-input" placeholder="Search team members...">
      </div>
      
      <div class="list-container" id="memberList">
        <!-- JS INJECTED -->
      </div>
    </section>

    <!-- RIGHT: EVENT CONTROL -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <i data-lucide="calendar-plus" size="18" style="color:var(--accent-purple);"></i> Scheduler
        </div>
      </div>
      
      <!-- Create Event Form -->
      <div class="form-section">
        <div class="input-group">
          <label class="label">Event Title</label>
          <input class="form-control" id="eTitle" placeholder="e.g. Client Demo">
        </div>

        <div class="input-group">
            <label class="label">Location / Link</label>
            <div style="position:relative;">
                <input class="form-control" id="eLoc" placeholder="e.g. Conference Room A or Zoom Link" style="padding-left:36px;">
                <i data-lucide="map-pin" size="14" style="position:absolute; left:12px; top:12px; color:var(--muted);"></i>
            </div>
        </div>
        
        <div class="flex-row">
          <div class="flex-1 input-group">
            <label class="label">Date</label>
            <input type="date" id="eDate" class="form-control" style="color-scheme: dark;">
          </div>
          <div class="flex-1 input-group">
            <label class="label">Time Range</label>
            <div style="display:flex; gap:4px; align-items:center;">
              <input type="time" id="eStart" class="form-control" value="09:00" style="color-scheme: dark;">
              <span style="color:var(--muted)">-</span>
              <input type="time" id="eEnd" class="form-control" value="10:00" style="color-scheme: dark;">
            </div>
          </div>
        </div>

        <div class="input-group">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                <label class="label" style="margin:0">Assignment</label>
                <button id="toggleManual" style="background:transparent; border:none; color:var(--accent); font-size:11px; cursor:pointer; font-weight:600;">Switch to Manual Select</button>
            </div>
            
            <!-- Auto Mode Input -->
            <div id="autoModeInput">
                <input type="number" id="eReq" class="form-control" value="1" min="1" placeholder="Quantity to Assign">
            </div>

            <!-- Manual Mode Input -->
            <div id="manualModeInput" style="display:none;">
                <div class="manual-select-container" id="manualSelect">
                    <!-- Checkboxes injected here -->
                </div>
            </div>
        </div>

        <div style="display:flex; gap:8px; margin-top:20px;">
            <button class="btn btn-secondary flex-1" id="saveDraftBtn">
                <i data-lucide="save" size="14"></i> Draft
            </button>
            <button class="btn btn-primary flex-1" id="createEventBtn">
              <i data-lucide="check" size="14"></i> Create Event
            </button>
        </div>
        <div id="assignResult" style="margin-top:10px; font-size:12px;"></div>
      </div>
      
      <!-- List Tabs -->
      <div class="list-tabs">
          <div class="tab-btn active" id="tabUpcoming" onclick="switchTab('events')">Upcoming</div>
          <div class="tab-btn" id="tabDrafts" onclick="switchTab('drafts')">Drafts</div>
      </div>

      <!-- Event/Draft List -->
      <div class="event-list" id="eventList">
        <!-- JS INJECTED -->
      </div>
    </section>

  </main>
</div>

<!-- Add Member Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h2 style="font-size:20px; font-weight:800; color:white; margin-bottom:20px;">Add New Member</h2>
    <input class="form-control" id="mName" placeholder="Full Name" style="margin-bottom:12px;">
    <input class="form-control" id="mEmail" placeholder="Email Address" style="margin-bottom:24px;">
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button class="btn btn-secondary" id="closeModal">Cancel</button>
      <button class="btn btn-primary" id="saveMember">Send Invite</button>
    </div>
  </div>
</div>

<!-- Insight Details Modal -->
<div class="modal-overlay" id="insightOverlay">
  <div class="modal">
    <h2 style="font-size:18px; font-weight:700; color:white; margin-bottom:8px;" id="insightTitle">Insight Details</h2>
    <p style="font-size:13px; color:var(--muted); margin-bottom:16px;" id="insightSub">Overview of team status</p>
    
    <div id="insightContent" class="insight-list">
        <!-- Content injected here -->
    </div>

    <div style="display:flex; justify-content:flex-end; margin-top:20px;">
      <button class="btn btn-secondary" onclick="document.getElementById('insightOverlay').classList.remove('open')">Close</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Message here</div>

<script>
  lucide.createIcons();

  // --- STATE ---
  // Clean Slate with Admin
  const state = {
    members: [
        {
            id: 'm1',
            name: localStorage.getItem('sa_username') || 'You (Admin)',
            email: 'admin@alphasquad.com',
            avail: { 
                mon:[], tue:[], wed:[], thu:[], fri:[], sat:[], sun:[] 
            },
            status: 'online'
        }
    ],
    events: [],
    drafts: [],
    manualMode: false,
    manualSelection: new Set(),
    activeTab: 'events'
  };

  // --- DOM ---
  const el = {
    list: document.getElementById('memberList'),
    eList: document.getElementById('eventList'),
    manualSelect: document.getElementById('manualSelect'),
    eTitle: document.getElementById('eTitle'),
    eLoc: document.getElementById('eLoc'),
    eDate: document.getElementById('eDate'),
    eStart: document.getElementById('eStart'),
    eEnd: document.getElementById('eEnd'),
    eReq: document.getElementById('eReq')
  };

  // --- HELPERS ---
  const getInitials = (name) => name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
  const showToast = (msg) => {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 3000);
  };
  function timeToMin(t) {
      if (!t) return 0;
      const [h, m] = t.split(':').map(Number);
      return (h * 60) + m;
  }
  function calcWeeklyHours(avail) {
      let total = 0;
      Object.values(avail).forEach(ranges => {
          ranges.forEach(r => {
             total += (timeToMin(r.end) - timeToMin(r.start))/60;
          });
      });
      return total;
  }

  // --- RENDER ---
  function render() {
    renderMembers();
    renderInsights();
    renderManualSelect();
    renderList();
    lucide.createIcons();
  }

  function renderMembers() {
    el.list.innerHTML = '';
    const dayKey = ['sun','mon','tue','wed','thu','fri','sat'][new Date().getDay()];
    
    // Split members
    const activeMembers = state.members.filter(m => m.status !== 'pending').sort((a,b) => calcWeeklyHours(b.avail) - calcWeeklyHours(a.avail));
    const pendingMembers = state.members.filter(m => m.status === 'pending');

    // Helper: Generate Week View HTML for active members
    const generateWeekView = (m) => {
        const days = ['mon','tue','wed','thu','fri','sat','sun'];
        let html = '<div id="details-'+m.id+'" class="member-week-view">';
        days.forEach(d => {
            const ranges = m.avail[d];
            const rangeStr = ranges && ranges.length > 0 
                ? ranges.map(r => `<span style="color:white;">${r.start}-${r.end}</span>`).join(', ') 
                : '-';
            
            html += `
                <div class="week-row">
                    <div class="week-day">${d.substring(0,3)}</div>
                    <div class="week-time">${rangeStr}</div>
                </div>
            `;
        });
        html += '</div>';
        return html;
    };

    // Helper render function
    const createCard = (m, canExpand) => {
        const hrs = calcWeeklyHours(m.avail);
        const ranges = m.avail[dayKey] || [];
        const isFreeToday = ranges.length > 0;
        const isPending = m.status === 'pending';
        
        const badgeHtml = isPending 
            ? `<span class="badge pending">Invite Sent</span>` 
            : `<span class="badge ${isFreeToday ? 'avail' : 'off'}">${isFreeToday ? 'Avail Today' : 'Off Today'}</span> <span style="font-size:11px; opacity:0.6">${hrs.toFixed(0)}h / wk</span>`;

        // Only add click handler for active members
        const clickAttr = canExpand ? `onclick="toggleMemberDetails('${m.id}')"` : '';
        const expandIcon = canExpand ? `<button class="btn-ghost" style="padding:4px;"><i data-lucide="chevron-down" size="14"></i></button>` : `<button class="btn-ghost" style="padding:4px;"><i data-lucide="more-vertical" size="14"></i></button>`;

        return `
            <div class="member-card" id="card-${m.id}" ${clickAttr}>
                <div class="member-card-header">
                    <div class="avatar">
                        ${getInitials(m.name)}
                        <div class="status-dot ${m.status}"></div>
                    </div>
                    <div class="member-info">
                        <div class="member-name">${m.name}</div>
                        <div class="member-sub">${badgeHtml}</div>
                    </div>
                    ${expandIcon}
                </div>
                ${canExpand ? generateWeekView(m) : ''}
            </div>
        `;
    };

    // Render Active
    activeMembers.forEach(m => el.list.innerHTML += createCard(m, true));

    // Render Pending Divider & List
    if (pendingMembers.length > 0) {
        el.list.innerHTML += `<div class="roster-divider">Pending Invites (${pendingMembers.length})</div>`;
        pendingMembers.forEach(m => el.list.innerHTML += createCard(m, false));
    }

    document.getElementById('memberCount').textContent = `${state.members.length} Members`;
  }

  // Toggle Function for Roster Expansion
  window.toggleMemberDetails = function(id) {
      const card = document.getElementById(`card-${id}`);
      if(card) {
          card.classList.toggle('expanded');
      }
  };

  function renderInsights() {
    const dayKey = ['sun','mon','tue','wed','thu','fri','sat'][new Date().getDay()];
    const activeMembers = state.members.filter(m => m.status !== 'pending');
    
    const availableMembers = activeMembers.filter(m => (m.avail[dayKey] || []).length > 0);
    const unavailableMembers = activeMembers.filter(m => (m.avail[dayKey] || []).length === 0);
    
    document.getElementById('availToday').textContent = availableMembers.length;
    document.getElementById('notAvailToday').textContent = unavailableMembers.length;
    document.getElementById('mostVacant').textContent = activeMembers[0]?.name.split(' ')[0] || '--'; 
  }

  window.openInsightModal = function(type) {
      const dayKey = ['sun','mon','tue','wed','thu','fri','sat'][new Date().getDay()];
      const activeMembers = state.members.filter(m => m.status !== 'pending');
      const content = document.getElementById('insightContent');
      const title = document.getElementById('insightTitle');
      const sub = document.getElementById('insightSub');
      
      content.innerHTML = '';
      let list = [];
      
      if (type === 'available') {
          title.textContent = "Available Today";
          sub.textContent = "Detailed time slots for today.";
          list = activeMembers.filter(m => (m.avail[dayKey] || []).length > 0);
      } else if (type === 'unavailable') {
          title.textContent = "Not Available Today";
          sub.textContent = "Members who are off or busy today.";
          list = activeMembers.filter(m => (m.avail[dayKey] || []).length === 0);
      } else if (type === 'vacant') {
          title.textContent = "Most Vacant Members";
          sub.textContent = "Ranked by total available hours (High to Low).";
          list = [...activeMembers].sort((a,b) => calcWeeklyHours(b.avail) - calcWeeklyHours(a.avail));
      }

      if (list.length === 0) {
          content.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted);">No members found.</div>';
      } else {
          list.forEach(m => {
              // Detailed Time Logic
              let detailText = '';
              if (type === 'available') {
                  const ranges = m.avail[dayKey];
                  // Join multiple intervals with comma
                  const times = ranges.map(r => `${r.start}-${r.end}`).join(', ');
                  detailText = `<span style="color:var(--accent); font-family:monospace; font-size:12px;">${times}</span>`;
              } else if (type === 'vacant') {
                  const hrs = calcWeeklyHours(m.avail);
                  detailText = `<span>${hrs.toFixed(0)}h / wk</span>`;
              } else {
                  detailText = `<span style="color:var(--danger)">OFF</span>`;
              }

              content.innerHTML += `
                  <div class="insight-item">
                      <span><b>${m.name}</b></span>
                      ${detailText}
                  </div>
              `;
          });
      }
      document.getElementById('insightOverlay').classList.add('open');
  }

  function renderManualSelect() {
    el.manualSelect.innerHTML = '';
    const activeMembers = state.members.filter(m => m.status !== 'pending');
    
    activeMembers.forEach(m => {
        const isSel = state.manualSelection.has(m.id);
        const div = document.createElement('div');
        div.className = `manual-option ${isSel ? 'selected' : ''}`;
        div.innerHTML = `
            <div style="width:16px; height:16px; border:1px solid var(--muted); border-radius:4px; display:flex; align-items:center; justify-content:center; background:${isSel ? 'var(--accent)' : 'transparent'}">
               ${isSel ? '<i data-lucide="check" size="10" color="black"></i>' : ''}
            </div>
            ${m.name}
        `;
        div.onclick = () => {
            if(isSel) state.manualSelection.delete(m.id);
            else state.manualSelection.add(m.id);
            renderManualSelect(); 
        };
        el.manualSelect.appendChild(div);
    });
  }

  function renderList() {
    el.eList.innerHTML = '';
    const items = state.activeTab === 'events' ? state.events : state.drafts;
    
    if(items.length === 0) {
        el.eList.innerHTML = `<div style="text-align:center; padding:40px; color:var(--muted); font-size:14px;">No ${state.activeTab} found.</div>`;
        return;
    }

    items.forEach((ev, index) => {
        let statusClass = 'assigned';
        if (state.activeTab === 'drafts') statusClass = 'draft';
        else if (ev.status === 'pending') statusClass = 'pending';

        const div = document.createElement('div');
        div.className = `event-card ${statusClass}`;
        
        let avatars = '';
        const assignedIds = ev.assigned || [];
        assignedIds.slice(0,4).forEach(uid => {
            const mem = state.members.find(m => m.id === uid);
            if(mem) avatars += `<div class="mini-avi" title="${mem.name}">${getInitials(mem.name)}</div>`;
        });
        if(assignedIds.length > 4) avatars += `<div class="mini-avi count">+${assignedIds.length - 4}</div>`;

        const fullNames = assignedIds.map(uid => {
            const mem = state.members.find(m => m.id === uid);
            return `<span class="assigned-tag">${mem ? mem.name : 'Unknown'}</span>`;
        }).join('');

        let statusBadge = '';
        if (state.activeTab === 'drafts') {
            statusBadge = '<span class="status-badge-inline">Draft</span>';
        } else if (ev.status === 'pending') {
            statusBadge = '<span class="status-badge-inline" style="color:var(--warning); border-color:var(--warning); background:rgba(250, 204, 21, 0.1);">Pending Confirmation</span>';
        }

        div.innerHTML = `
            <div class="event-head">
                <div>
                    <div class="event-title">
                        ${ev.title || 'Untitled Event'}
                        ${statusBadge}
                    </div>
                    <div class="event-loc"><i data-lucide="map-pin" size="12"></i> ${ev.loc || 'Remote'}</div>
                </div>
                <div style="font-size:12px; font-weight:700; color:var(--accent); text-align:right;">
                    ${ev.start}<br><span style="color:var(--muted); font-weight:400;">${ev.date}</span>
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                <span class="badge" style="background:rgba(255,255,255,0.05)">${assignedIds.length} Assigned</span>
                <div class="team-avatars" style="margin:0; padding:0; border:none;">${avatars}</div>
            </div>
            
            <div class="event-details">
                ${state.activeTab === 'drafts' ? `<button class="btn-ghost" style="width:100%; margin-bottom:12px; font-size:11px; border:1px dashed var(--accent); color:var(--accent);" onclick="restoreDraft(${index}, event)">⚡ Restore to Editor</button>` : ''}
                
                <div class="detail-label">Location Details</div>
                <div style="font-size:13px; color:white; margin-bottom:12px;">${ev.loc || 'No location specified'}</div>
                
                <div class="detail-label">Full Roster</div>
                <div class="assigned-list">
                    ${fullNames || '<span style="color:var(--muted); font-size:12px;">No members selected</span>'}
                </div>
                
                ${state.activeTab === 'drafts' ? `<button class="btn-ghost" style="width:100%; margin-top:12px; font-size:11px; color:var(--danger);" onclick="deleteDraft(${index}, event)">Delete Draft</button>` : ''}
            </div>
        `;
        
        div.onclick = (e) => {
            if(e.target.tagName !== 'BUTTON') div.classList.toggle('expanded');
        };
        el.eList.appendChild(div);
    });
  }

  // --- ACTIONS ---
  window.switchTab = (tab) => {
      state.activeTab = tab;
      document.getElementById('tabUpcoming').classList.toggle('active', tab === 'events');
      document.getElementById('tabDrafts').classList.toggle('active', tab === 'drafts');
      renderList();
      lucide.createIcons();
  };

  document.getElementById('toggleManual').onclick = () => {
      state.manualMode = !state.manualMode;
      document.getElementById('toggleManual').textContent = state.manualMode ? "Switch to Auto Assign" : "Switch to Manual Select";
      document.getElementById('autoModeInput').style.display = state.manualMode ? 'none' : 'block';
      document.getElementById('manualModeInput').style.display = state.manualMode ? 'block' : 'none';
  };

  function getFormData() {
      return {
          title: el.eTitle.value,
          date: el.eDate.value,
          start: el.eStart.value,
          end: el.eEnd.value,
          loc: el.eLoc.value,
          manualMode: state.manualMode,
          manualSelection: Array.from(state.manualSelection),
          req: el.eReq.value
      };
  }

  document.getElementById('saveDraftBtn').onclick = () => {
      const data = getFormData();
      if(!data.title) return showToast('Event title required for draft');
      
      state.drafts.unshift({
          ...data,
          assigned: data.manualMode ? data.manualSelection : [],
          id: 'd'+Date.now()
      });
      showToast('Draft Saved');
      switchTab('drafts');
  };

  window.restoreDraft = (index, e) => {
      e.stopPropagation();
      const draft = state.drafts[index];
      
      el.eTitle.value = draft.title;
      el.eDate.value = draft.date;
      el.eStart.value = draft.start;
      el.eEnd.value = draft.end;
      el.eLoc.value = draft.loc;
      el.eReq.value = draft.req;

      state.manualMode = draft.manualMode;
      document.getElementById('toggleManual').textContent = state.manualMode ? "Switch to Auto Assign" : "Switch to Manual Select";
      document.getElementById('autoModeInput').style.display = state.manualMode ? 'none' : 'block';
      document.getElementById('manualModeInput').style.display = state.manualMode ? 'block' : 'none';

      state.manualSelection = new Set(draft.manualSelection);
      state.drafts.splice(index, 1);
      
      renderManualSelect();
      renderList();
      showToast('Draft Restored to Editor');
  };

  window.deleteDraft = (index, e) => {
      e.stopPropagation();
      if(confirm('Delete this draft?')) {
          state.drafts.splice(index, 1);
          renderList();
      }
  };

  document.getElementById('createEventBtn').onclick = () => {
      const data = getFormData();

      if(!data.title || !data.date) return showToast('Title and Date required');

      let assignedIds = [];

      if(state.manualMode) {
          assignedIds = data.manualSelection;
          if(assignedIds.length === 0) return showToast('Select at least one member');
      } else {
          // Exclude pending members from auto-assign
          const req = parseInt(data.req) || 1;
          const dayKey = ['sun','mon','tue','wed','thu','fri','sat'][new Date(data.date).getDay()];
          const sMin = timeToMin(data.start);
          const eMin = timeToMin(data.end);

          const available = state.members.filter(m => {
              // Ensure member is not pending
              if (m.status === 'pending') return false;
              // Check ALL intervals for the day
              const ranges = m.avail[dayKey] || [];
              return ranges.some(r => timeToMin(r.start) <= sMin && timeToMin(r.end) >= eMin);
          });

          if(available.length < req) {
              if(!confirm(`Only ${available.length} active members available. Assign them?`)) return;
          }
          assignedIds = available.slice(0, req).map(m => m.id);
      }

      state.events.unshift({
          id: 'e'+Date.now(),
          title: data.title, 
          date: data.date, 
          start: data.start, 
          end: data.end, 
          loc: data.loc, 
          assigned: assignedIds,
          status: 'pending' // Default new events to pending
      });

      el.eTitle.value = ''; el.eLoc.value = '';
      state.manualSelection.clear();
      render();
      switchTab('events');
      showToast('Event Created Successfully');
  };

  el.eDate.valueAsDate = new Date();
  render();

  document.getElementById('openAddMember').onclick = () => document.getElementById('modalOverlay').classList.add('open');
  document.getElementById('closeModal').onclick = () => document.getElementById('modalOverlay').classList.remove('open');
  
  // UPDATED: Save Member Logic with Pending Status
  document.getElementById('saveMember').onclick = () => {
      const name = document.getElementById('mName').value;
      const email = document.getElementById('mEmail').value; // Grab email
      if(!name) return;
      
      const newMember = {
          id: 'm'+Date.now(),
          name: name,
          email: email || name.split(' ')[0].toLowerCase()+'@alphasquad.com',
          avail: {}, // No avail yet
          status: 'pending' // New Status
      };
      
      state.members.push(newMember);
      
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('mName').value = '';
      document.getElementById('mEmail').value = '';
      
      render();
      showToast(`Invitation sent to ${newMember.email}`);
  };

</script>
</body>
</html>