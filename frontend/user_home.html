<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>My Hub â€” SCHED-i</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- KEEPING THE FONT AS REQUESTED -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<script src="sched.js"></script>

<style>
  :root { 
    --text: #ffffff; 
    --muted: rgba(255, 255, 255, 0.6); 
    --accent: #e879f9; 
    --accent-secondary: #818cf8; 
    --success: #4ade80;
    --danger: #fb7185;
    --warning: #facc15;
    
    /* UPDATED: Darker Glass, Visible Border */
    
    /* Increased from 0.05 to 0.1 for better readability */
    --glass: rgba(255, 255, 255, 0.1);
    
    /* Hover stays slightly brighter for feedback */
    --glass-hover: rgba(255, 255, 255, 0.1);
    
    /* Border stays sharp (0.2) to keep the separation you wanted */
    --border: rgba(255, 255, 255, 0.2);
    
    --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
    --blur: blur(20px);
}
  /* ANIMATED BACKGROUND */
/* ANIMATED BACKGROUND - Smoother & Darker */
body { 
    /* Changed the bright #4c1d95 to a deeper #1e1b4b (Midnight Blue) */
    background: linear-gradient(-45deg, #02010a, #1e1b4b, #1e0b36, #0f0518);
    background-size: 400% 400%;
    
    /* Slowed down from 8s to 20s for a very calm shift */
    animation: gradientBG 20s ease infinite;
    
    color: var(--text); 
    font-family: 'Inter', sans-serif; 
    min-height: 100vh; 
    overflow-x: hidden;
    position: relative;
}

@keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

  /* CUSTOM SCROLLBAR (Matches Dark Theme) */
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: #02010a; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

  @keyframes gradientBG {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* MISSING COMPONENT: FLOATING ORBS */
  /* FLOATING ORBS - Alive & Breathing */
.orb {
    position: absolute; border-radius: 50%; 
    filter: blur(80px); 
    z-index: -1;
    pointer-events: none;
    
    /* Sped up from 20s to 12s */
    animation: floatOrb 12s infinite ease-in-out;
}
/* Increased Opacity slightly for visibility */
.orb-1 { width: 400px; height: 400px; background: var(--accent); top: -100px; left: -100px; opacity: 0.5; }
.orb-2 { width: 300px; height: 300px; background: var(--accent-secondary); bottom: 10%; right: -50px; animation-delay: -3s; opacity: 0.4; }
.orb-3 { width: 200px; height: 200px; background: #4c1d95; top: 40%; left: 30%; animation-delay: -6s; opacity: 0.3; }

@keyframes floatOrb {
    0% { transform: translate(0, 0) scale(1); opacity: 0.4; }
    33% { transform: translate(50px, -50px) scale(1.2); opacity: 0.6; } /* Moves further & grows */
    66% { transform: translate(-30px, 40px) scale(0.9); opacity: 0.4; } /* Shrinks */
    100% { transform: translate(0, 0) scale(1); opacity: 0.4; }
}

  /* Keyframes for Staggered Calendar */
  @keyframes popIn {
    0% { opacity: 0; transform: scale(0.5); }
    70% { transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
  }

  /* Shimmer Effect for Hero */
  @keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
  }

  @keyframes slideInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes pulseSoft {
    0% { box-shadow: 0 0 0 0 rgba(232, 121, 249, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(232, 121, 249, 0); }
    100% { box-shadow: 0 0 0 0 rgba(232, 121, 249, 0); }
  }

  .container { max-width: 1000px; margin: 0 auto; padding: 32px 24px; position: relative; z-index: 1; }
  
  /* Header & Navigation */
  header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; animation: slideInUp 0.5s ease; }
  /* 1. Make the Logo Image Bigger */
.logo-img { 
    width: 50px;   /* Increased from 36px */
    height: 50px;  /* Increased from 36px */
    
    border-radius: 10px; 
    object-fit: contain; 
    box-shadow: 0 0 15px rgba(232, 121, 249, 0.5); 
    background: rgba(255,255,255,0.1); 
}

/* 2. Make the "SCHED-i" Text Bigger */
.logo { 
    font-weight: 800; 
    font-size: 32px;
    
    display: flex; gap: 16px; align-items: center; 
    
    /* GRADIENT TEXT SETTINGS */
    background: linear-gradient(135deg, #ffffff 30%, #e879f9 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    
    /* Remove standard text-shadow as it clashes with gradient text */
    /* Use drop-shadow filter if you want a glow */
    filter: drop-shadow(0 2px 10px rgba(232, 121, 249, 0.3));
    
    letter-spacing: -1px;

}
  
  .header-actions { display: flex; align-items: center; gap: 12px; }

  /* Emphasized Header Buttons with Interaction */
  .header-btn-primary {
      font-size: 13px; font-weight: 600; color: white;
      padding: 8px 16px; border-radius: 20px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer; display: flex; align-items: center; gap: 6px;
      background: linear-gradient(135deg, rgba(232, 121, 249, 0.2), rgba(129, 140, 248, 0.2)); 
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .header-btn-primary:hover { 
      background: linear-gradient(135deg, rgba(232, 121, 249, 0.4), rgba(129, 140, 248, 0.4)); 
      transform: translateY(-2px); box-shadow: 0 8px 20px rgba(232, 121, 249, 0.25); border-color: white;
  }
  .header-btn-primary:active { transform: scale(0.95); }

  .logout { 
    color: var(--muted); font-size: 14px; cursor: pointer; transition: 0.3s; 
    display:flex; align-items:center; gap:6px; padding: 8px 16px; border-radius: 20px;
    background: rgba(0,0,0,0.3); border: 1px solid transparent;
  }
  .logout:hover { color: white; background: rgba(255,255,255,0.1); border-color: var(--border); transform: scale(1.05); }

  /* Tab Navigation */
  .nav-tabs { 
    display: flex; gap: 8px; margin-bottom: 32px; padding: 6px; 
    background: rgba(0,0,0,0.2); border-radius: 30px; width: fit-content; 
    border: 1px solid var(--border); backdrop-filter: var(--blur); 
    animation: slideInUp 0.6s ease;
  }
  .tab-btn {
    background: transparent; border: none; color: var(--muted); 
    padding: 10px 24px; font-size: 14px; font-weight: 600; border-radius: 24px;
    cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    display: flex; align-items: center; gap: 8px; position: relative; overflow: hidden;
  }
  .tab-btn:hover { color: white; background: rgba(255,255,255,0.05); }
  .tab-btn.active { 
    background: rgba(255,255,255,0.15); color: white; 
    border: 1px solid rgba(255,255,255,0.2); 
    box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
    transform: scale(1.02);
  }
  .tab-btn.active i { color: var(--accent); }

  /* SECTIONS & ANIMATIONS */
  .section-content { display: none; }
  .section-content.active { display: block; }
  .animate-stagger-1 { animation: slideInUp 0.5s ease forwards; opacity: 0; animation-delay: 0.1s; }
  .animate-stagger-2 { animation: slideInUp 0.5s ease forwards; opacity: 0; animation-delay: 0.2s; }
  .animate-stagger-3 { animation: slideInUp 0.5s ease forwards; opacity: 0; animation-delay: 0.3s; }

  /* CARDS - Standardized Glassmorphism */
  .card { 
    background: var(--glass); 
    border: 1px solid var(--border); 
    border-radius: 20px; padding: 24px; margin-bottom: 24px; 
    backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
    box-shadow: var(--shadow);
    transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.3s ease;
  }
  .card:hover { transform: translateY(-4px); box-shadow: 0 15px 35px rgba(0,0,0,0.5); border-color: rgba(255,255,255,0.25); }
  
  .grid-2 { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 24px; align-items: start; }
  
  /* 1. OVERVIEW SECTION STYLES */
  .welcome-box {
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 24px;
    backdrop-filter: var(--blur);
    display: flex;
    flex-direction: column;
    gap: 8px;
    box-shadow: var(--shadow);
    min-height: 120px; 
    justify-content: center;
  }
  
  .welcome-title { 
      font-size: 24px; 
      font-weight: 800; 
      color: white; 
      letter-spacing: -1.5px; 
      text-shadow: 0 4px 12px rgba(0,0,0,0.3);
      line-height: 1.1;
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      max-width: 100%;
  }
  .welcome-sub { 
      color: var(--accent); 
      font-size: 16px; 
      font-weight: 500; 
      display:flex; align-items: center; gap: 8px; 
  }

  /* Next Up Hero - With Shimmer Animation */
  .next-up-hero {
    background: linear-gradient(135deg, rgba(232, 121, 249, 0.1), rgba(129, 140, 248, 0.05));
    border: 1px solid rgba(232, 121, 249, 0.3);
    padding: 32px; border-radius: 24px; margin-bottom: 32px;
    backdrop-filter: var(--blur);
    box-shadow: var(--shadow);
    position: relative; overflow: hidden;
    display: flex; justify-content: space-between; align-items: center;
    animation: slideInUp 0.6s ease;
  }
  .next-up-hero::before {
      content: "";
      position: absolute; top: 0; left: -50%; width: 200%; height: 100%;
      background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.05) 50%, transparent 100%);
      transform: skewX(-20deg);
      animation: shimmer 6s infinite linear;
      pointer-events: none;
  }
  .next-up-hero:hover { border-color: var(--accent); }
  
  .hero-label { 
    font-size: 12px; text-transform: uppercase; letter-spacing: 2px; 
    color: var(--accent); font-weight: 700; margin-bottom: 12px; 
    display: flex; align-items: center; gap: 8px; 
    animation: pulseSoft 2s infinite; border-radius: 20px; width: fit-content;
  }
  .hero-time { font-family: 'Inter', sans-serif; font-size: 14px; color: rgba(255,255,255,0.8); display:flex; align-items:center; gap:8px; margin-top: 8px; }

  /* Workspaces */
  .team-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px; background: rgba(255,255,255,0.02); border-radius: 16px;
    border: 1px solid var(--border); cursor: pointer; transition: all 0.3s ease; margin-bottom: 16px;
  }
  .team-item:hover { 
    border-color: var(--accent); 
    background: linear-gradient(90deg, rgba(232, 121, 249, 0.1), rgba(255,255,255,0.02));
    transform: translateX(5px) scale(1.01); 
  }
    /* Make team/workspace cards more prominent */
    .team-item { box-shadow: 0 6px 20px rgba(0,0,0,0.45); border-left: 4px solid rgba(124,92,255,0.15); padding: 18px 22px; }
    .team-item .team-info h4 { font-size: 18px; color: white; }
    .team-item .team-info span { color: rgba(255,255,255,0.75); }
  .team-icon { width: 48px; height: 48px; background: rgba(255,255,255,0.03); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 1px solid var(--border); flex-shrink: 0; transition: transform 0.3s; }
  .team-item:hover .team-icon { transform: scale(1.1) rotate(5deg); background: rgba(255,255,255,0.1); border-color: var(--accent); }
  .team-info h4 { font-size: 16px; font-weight: 700; margin-bottom: 2px; color: white; }
  .team-info span { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }

  /* Action Buttons Grid */
  .action-grid { display: block; margin-top: 20px; }
  .action-btn-full {
    width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;
    padding: 16px; border-radius: 16px; border: 1px solid var(--border);
    background: rgba(255,255,255,0.02); color: var(--muted); 
    cursor: pointer; transition: 0.3s; font-size: 13px; font-weight: 600;
  }
  .action-btn-full:hover { background: rgba(255,255,255,0.08); border-color: white; color: white; transform: translateY(-2px); }
  .action-btn-full:active { transform: scale(0.98); }

  /* Activity List */
  .activity-list { display: flex; flex-direction: column; gap: 16px; }
  .activity-item { display: flex; gap: 16px; align-items: start; padding-bottom: 16px; border-bottom: 1px solid var(--border); transition: transform 0.2s; }
  .activity-item:hover { transform: translateX(4px); }
  .activity-item:last-child { border-bottom: none; padding-bottom: 0; }
  .act-icon { width: 32px; height: 32px; border-radius: 50%; background: rgba(232, 121, 249, 0.1); border: 1px solid rgba(232, 121, 249, 0.3); display: flex; align-items: center; justify-content: center; color: var(--accent); flex-shrink: 0; }
  .act-content { font-size: 13px; color: var(--muted); line-height: 1.4; }
  .act-content b { color: white; font-weight: 600; }
  .act-time { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 4px; }

  /* 2. CALENDAR SECTION */
  .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
  .cal-day-name { text-align: center; color: var(--muted); font-size: 12px; font-weight: 600; padding-bottom: 8px; }
  .cal-date { 
    height: 54px; border-radius: 12px; background: var(--glass); 
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 14px; color: var(--muted); cursor: pointer; transition: all 0.2s;
    border: 1px solid transparent; position: relative;
    opacity: 0; transform: scale(0.8);
  }
  
  .cal-date.animate-in {
      animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  }

  .cal-date:hover { background: rgba(255,255,255,0.1); color: white; border-color: var(--accent); transform: scale(1.05); z-index: 2; }
  
  .cal-date.today {
      border: 1px solid white;
      box-shadow: 0 0 10px rgba(255,255,255,0.2);
      font-weight: 700; color: white;
  }
  .cal-date.event-alpha {
      background: rgba(232, 121, 249, 0.25);
      border: 1px solid rgba(232, 121, 249, 0.5);
      color: white;
  }
  .cal-date.event-medicare {
      background: rgba(129, 140, 248, 0.25);
      border: 1px solid rgba(129, 140, 248, 0.5);
      color: white;
  }
  .cal-date.event-holiday {
      background: rgba(74, 222, 128, 0.15);
      border: 1px solid rgba(74, 222, 128, 0.4);
      color: white;
  }
  /* Dynamic gradient will be applied inline based on event colors */
  .cal-date.has-events::after {
      content: '';
      position: absolute; left: 6px; right: 6px; bottom: 6px; height: 4px; border-radius: 6px;
      background: var(--event-gradient, linear-gradient(90deg, var(--accent), var(--accent-secondary)));
      opacity: 0.95;
  }
  .cal-date.has-availability::after {
      content: '';
      position: absolute; left: 6px; right: 6px; bottom: 6px; height: 4px; border-radius: 6px;
      background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
      opacity: 0.95;
  }
  .cal-date.blocked-day { background: rgba(251,113,133,0.08); border-color: rgba(251,113,133,0.2); }
    /* Personal Event Modal */
    #personalEventModal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 20000; }
    #personalEventModal.open { display: flex; }
    #personalEventModal > div { background: rgba(0,0,0,0.85); padding:20px; border-radius:12px; width:420px; box-shadow:0 20px 60px rgba(0,0,0,0.6); }
    .personal-modal-box .modal-input { background: rgba(0,0,0,0.45); border: 1px solid var(--border); color: white; padding:8px 10px; border-radius:8px; }

    /* Time scroll picker styles */
    .time-picker-container { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .time-picker { flex: 1; display: flex; flex-direction: column; align-items: center; }
    .time-picker-label { font-size: 11px; color: var(--muted); font-weight: 700; margin-bottom: 4px; text-transform: uppercase; }
    .time-picker-scroll { 
        height: 120px; 
        width: 60px;
        background: rgba(0,0,0,0.3); 
        border: 1px solid var(--border); 
        border-radius: 8px;
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        display: flex;
        flex-direction: column;
        padding: 40px 0;
        box-sizing: content-box;
    }
    .time-picker-scroll::-webkit-scrollbar { width: 4px; }
    .time-picker-scroll::-webkit-scrollbar-track { background: transparent; }
    .time-picker-scroll::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 2px; }
    .time-picker-item {
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-weight: 500;
        scroll-snap-align: center;
        cursor: pointer;
        transition: color 0.2s;
    }
    .time-picker-item.selected { color: var(--accent); font-weight: 700; }
    .time-picker-item:hover { color: white; }
    .time-picker-center { 
        position: absolute; 
        width: 60px; 
        height: 32px; 
        border-top: 1px solid rgba(255,255,255,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.1);
        pointer-events: none;
    }

    /* Overlap confirmation modal (same open class) */
    #overlapConfirmModal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 21000; }
    #overlapConfirmModal.open { display: flex; }

        /* Event badges in upper-left: show up to 3 small pill badges, then a +N overflow */
        .cal-badges { position: absolute; top: 8px; left: 8px; display:flex; flex-direction:column; gap:6px; align-items:flex-start; z-index:3; }
        .ev-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 6px; border-radius:8px; font-size:11px; font-weight:700; color:white; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.06); box-shadow: 0 6px 16px rgba(0,0,0,0.18); min-width:28px; max-width:86px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .ev-badge.small { padding:3px 6px; font-size:10px; border-radius:6px; }
        .ev-badge .eb-label { display:inline-block; padding:2px 6px; border-radius:6px; background:rgba(0,0,0,0.12); font-weight:800; font-size:11px; }
        .ev-more { display:inline-flex; align-items:center; justify-content:center; width:30px; height:18px; border-radius:8px; font-size:11px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06); }
        .ev-badge.glow { box-shadow: 0 6px 18px currentColor; }
        .cal-badges a { color: inherit; text-decoration:none; }

  /* 3. PROFILE SECTION */
  .profile-header { display: flex; align-items: flex-start; gap: 24px; margin-bottom: 32px; }
  .profile-avatar-lg { 
    width: 100px; height: 100px; border-radius: 50%; 
    background: linear-gradient(135deg, #4c1d95, #831843); 
    border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; 
    font-size: 32px; color: var(--muted); overflow: hidden; cursor: pointer; position: relative; 
    box-shadow: 0 8px 24px rgba(0,0,0,0.3); flex-shrink: 0; 
    transition: transform 0.3s;
  }
  .profile-avatar-lg:hover { transform: scale(1.05); border-color: var(--accent); }
  .profile-avatar-lg:hover::after { content:'Edit'; position: absolute; inset:0; background:rgba(0,0,0,0.6); font-size:12px; display:flex; align-items:center; justify-content:center; color:white; font-weight: 600; animation: fadeIn 0.2s; }
  
  .profile-info-edit { flex: 1; display: flex; flex-direction: column; gap: 12px; }
  .profile-field-group { display: flex; flex-direction: column; gap: 4px; }
  .profile-label { font-size: 11px; color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; margin-bottom: 2px; }
  
  .profile-input { 
      background: rgba(0,0,0,0.2); border: 1px solid var(--border); 
      border-radius: 8px; padding: 10px 14px; color: white; font-size: 14px; width: 100%;
      transition: all 0.2s;
  }
  .profile-input:focus { outline: none; border-color: var(--accent); background: rgba(0,0,0,0.4); box-shadow: 0 0 10px rgba(232,121,249,0.2); transform: translateY(-1px); }
  .profile-input.title { font-size: 24px; font-weight: 800; padding: 4px 0; background: transparent; border: none; border-bottom: 1px solid transparent; border-radius: 0; }
  .profile-input.title:focus { border-bottom-color: var(--accent); box-shadow: none; transform: none; }

  /* Status Badge */
  .status-btn {
      font-size:11px; padding:6px 14px; border-radius:20px; 
      border:1px solid transparent; font-weight:600; cursor: pointer; transition: 0.2s;
      display: inline-flex; align-items: center; gap: 6px; width: fit-content;
  }
  .status-btn.active { background:rgba(232, 121, 249, 0.15); color:var(--accent); border-color:rgba(232, 121, 249, 0.3); }
  .status-btn.busy { background:rgba(251,113,133,0.15); color:var(--danger); border-color:rgba(251,113,133,0.3); }
  .status-btn.offline { background:rgba(148,163,184,0.15); color:var(--muted); border-color:rgba(148,163,184,0.3); }
  
  /* FIXED: Availability Grid & Green Gradient Add Button */
  .avail-grid { display: flex; flex-direction: column; gap: 12px; }
  .avail-row { 
      display: flex; justify-content: space-between; align-items: flex-start; 
      padding: 16px; background: rgba(255,255,255,0.03); 
      border-radius: 12px; border: 1px solid var(--border); transition: 0.2s;
      flex-wrap: wrap;
  }
  .avail-row:hover { border-color: var(--accent); background: rgba(255,255,255,0.05); }
  .avail-day { font-weight: 700; font-size: 14px; color: white; width: 60px; padding-top: 10px; }
  
  .avail-right-col { 
    display: flex; 
    flex-direction: row; 
    align-items: center; 
    gap: 8px; 
    
    /* This makes it compact */
    width: fit-content; 
    flex: none; 
}
  
  .interval-list { display: flex; flex-direction: column; gap: 8px; width: 100%; }
    .interval-group { display: flex; align-items: center; gap: 8px; width: 100%; animation: fadeIn 0.28s ease; }

    /* Pop-in animation for newly added shifts */
    .animate-pop { animation: popIn 220ms cubic-bezier(.2,.9,.3,1) both; }
    @keyframes popIn { from { opacity: 0; transform: translateY(-6px) scale(0.985); } to { opacity:1; transform: translateY(0) scale(1);} }

    /* Removal animation */
    .interval-group.removing { animation: removeOut 220ms cubic-bezier(.2,.9,.3,1) both; }
    @keyframes removeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateX(12px) scale(0.98); } }

    /* Slight hover highlight for interval rows */
    .interval-group:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.45); background: rgba(255,255,255,0.02); border-radius: 8px; }

    /* Inline validation state for interval rows */
    .interval-group.invalid { border-color: rgba(251,113,133,0.9); box-shadow: 0 8px 30px rgba(251,113,133,0.06); background: rgba(251,113,133,0.02); }
    .interval-group .error-icon { display: none; width:20px; height:20px; border-radius:50%; background: rgba(251,113,133,0.95); color: white; align-items:center; justify-content:center; font-size:12px; }
    .interval-group.invalid .error-icon { display:flex; margin-left:6px; }

    /* Inline persistent error text for interval rows */
    .inline-error { margin-left:8px; background: rgba(251,113,133,0.06); color: var(--danger); padding:6px 8px; border-radius:6px; font-size:12px; font-weight:700; display:inline-block; }

    /* calendar indicator legacy rules removed in favor of badge UI */
  
  .avail-input { 
    background: rgba(0,0,0,0.4); 
    border: 1px solid var(--border); 
    color: white; 
    border-radius: 8px; 
    font-family: monospace; 
    font-size: 13px; 
    text-align: center;
    color-scheme: dark;
    
    /* Force specific size */
    height: 34px; 
    width: 105px;
    padding: 0; /* Remove padding that affects height calculation */
}
.avail-input:focus { border-color: var(--accent); outline: none; }
    .shift-type, .shift-label {
        background: rgba(0,0,0,0.45);
        border: 1px solid var(--border);
        color: white;
        height: 34px;
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 13px;
    }
    .shift-label { min-width: 140px; }
  
  .btn-icon-small { 
    width: 32px; height: 32px; border-radius: 8px; 
    display: flex; align-items: center; justify-content: center; 
    background: rgba(255,255,255,0.05); color: var(--muted); cursor: pointer; 
    border: 1px solid transparent; transition: 0.2s; flex-shrink: 0;
  }
  .btn-icon-small:hover { transform: scale(1.1); background: rgba(255,255,255,0.1); color: white; }
  
  /* Green Gradient Add Shift Button */
  .btn-add-row { 
    font-size: 11px; font-weight: 700; color: #fff; cursor: pointer;
    
    /* Flex alignment */
    display: flex; 
    align-items: center; 
    justify-content: center;
    gap: 4px; 
    
    margin: 0; 
    width: fit-content;
    
    /* MATCHING HEIGHT */
    height: 34px;
    padding: 0 14px; /* Horizontal padding only */
    
    border-radius: 8px; /* Matching border radius looks cleaner */
    background: linear-gradient(135deg, #22c55e, #16a34a); 
    box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3);
}
.btn-add-row:hover { transform: translateY(-1px); box-shadow: 0 6px 15px rgba(34, 197, 94, 0.4); }
.btn-add-row:active { transform: scale(0.98); }
  
  .btn-remove { color: var(--danger); }
  .btn-remove:hover { background: rgba(251, 113, 133, 0.2); }

  /* Shared Button Style for Save/View actions */
  .btn-primary-action {
      background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
      color: white; font-weight: 600; font-size: 14px;
      padding: 10px 20px; border-radius: 12px;
      border: none; cursor: pointer; display: flex; align-items: center; gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.2s;
      width: fit-content;
  }
  .btn-primary-action:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(232, 121, 249, 0.4);
  }
    .btn-primary-action[disabled] { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-primary-action:active { transform: scale(0.97); }

  /* UPDATED LOADING ANIMATION: MODERN FILL BOX */
  #loadingOverlay {
      position: fixed; inset: 0; background: #02010a; z-index: 9999;
      display: none; align-items: center; justify-content: center; flex-direction: column;
  }
  
  .loader-box-container {
      width: 180px; height: 6px; 
      background: rgba(255,255,255,0.1); border-radius: 10px;
      overflow: hidden; position: relative; margin-bottom: 20px;
  }
  
  .loader-box-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
      animation: fillBox 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(232, 121, 249, 0.5);
  }

  /* TOAST NOTIFICATION */
  #toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(50px);
    background: rgba(20, 20, 30, 0.95); border: 1px solid var(--accent);
    color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: 600;
    opacity: 0; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; z-index: 10000;
    display: flex; align-items: center; gap: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  @keyframes fillBox {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
  }
  
  /* RESPONSIVE FIXES */
  @media(max-width: 900px) { 
    .grid-2 { grid-template-columns: 1fr; } 
  }

  @media(max-width: 600px) {
    .container { padding: 16px; }
    .nav-tabs { width: 100%; overflow-x: auto; justify-content: flex-start; scroll-behavior: smooth; }
    .nav-tabs::-webkit-scrollbar { display: none; }
    .tab-btn { white-space: nowrap; padding: 10px 16px; }
    
    .next-up-hero { flex-direction: column; align-items: flex-start; gap: 16px; padding: 24px; }
    .next-up-hero > div:last-child { width: 100%; }
    .next-up-hero .btn { width: 100%; justify-content: center; }
    
    .profile-header { flex-direction: column; align-items: center; text-align: center; }
    .profile-field-group input { text-align: center; }
    
    .avail-row { flex-direction: column; gap: 8px; }
    .avail-day { width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 8px; padding-bottom: 4px; padding-top: 0; }
    
    .header-actions { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); padding: 12px; z-index: 100; justify-content: center; border-top: 1px solid var(--border); }
    .header-btn-primary { font-size: 12px; padding: 6px 12px; }
    .logout { display: none; }
    .container { padding-bottom: 80px; }
    .btn-primary-action { width: 100%; justify-content: center; }
  }
</style>
</head>
<body>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>

    <div class="container">
<!-- LOADING ANIMATION -->
<div id="loadingOverlay">
    <div class="loader-box-container">
        <div class="loader-box-fill"></div>
    </div>
    <div style="color:white; font-weight:600; font-size:12px; letter-spacing:2px; text-transform:uppercase; opacity:0.8;">Navigating...</div>
</div>

<!-- TOAST -->
<div id="toast"><i data-lucide="check-circle" width="18" style="color:var(--success)"></i> <span id="toastMsg">Action Successful</span></div>

<div class="container">
    <header>
        <div class="logo">
           <img src="LOGO.png" alt="Logo" class="logo-img">
           SCHED-i
        </div>
        
        <div class="header-actions">
            <!-- EMPHASIZED BUTTONS -->
            <button class="header-btn-primary" onclick="navigateWithAnimation('create_team.html')">
                <i data-lucide="plus-circle" width="16"></i> <span>Create Team</span>
            </button>
            <button class="header-btn-primary" onclick="navigateWithAnimation('join_team.html')">
                <i data-lucide="users" width="16"></i> <span>Join Team</span>
            </button>
            <div class="logout" onclick="window.location.href='login.html'">
               <i data-lucide="log-out" width="16"></i> <span class="hidden sm:inline">Sign Out</span>
            </div>
        </div>
    </header>

    <!-- TAB NAVIGATION -->
    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('overview', this)">
            <i data-lucide="layout-dashboard" width="16"></i> Overview
        </button>
        <button class="tab-btn" onclick="switchTab('calendar', this)">
            <i data-lucide="calendar" width="16"></i> Calendar
        </button>
        <button class="tab-btn" onclick="switchTab('profile', this)">
            <i data-lucide="user" width="16"></i> Profile
        </button>
    </div>

    <!-- 1. OVERVIEW SECTION -->
    <div id="overview" class="section-content active">
        
        <!-- NEW WELCOME BOX -->
        <div class="welcome-box animate-stagger-1">
            <h1 class="welcome-title" id="welcomeMsg">Welcome back</h1>
            <p class="welcome-sub">
              <i data-lucide="calendar-check" width="16"></i>
              <span id="currentDateDisplay"></span>
            </p>
        </div>

        <!-- Hero: Next Meeting -->
        <div class="next-up-hero">
            <div>
                <div class="hero-label">
                    <i data-lucide="zap" width="14" fill="var(--accent)"></i> Happening Next
                </div>
                <div style="font-size: 28px; font-weight: 800; color: white; margin-bottom: 8px; letter-spacing: -0.5px; line-height: 1.2;">
                  Reading
                </div>
                <div class="hero-time">
                    <span style="background:rgba(232, 121, 249, 0.15); color:var(--accent); padding:4px 10px; border-radius:8px; font-weight:700; font-size:13px; border:1px solid rgba(232, 121, 249, 0.3);">
                        Dec 13 &bull; 10:00 AM - 11:00 AM
                    </span>
                    <span style="color:rgba(255,255,255,0.5);">|</span>
                    <span style="display:flex; align-items:center; gap:4px;"><i data-lucide="map-pin" width="14"></i> Medicare</span>
                </div>
            </div>
            <div style="text-align:right;">
                <!-- Lead to date details -->
                <button class="btn-primary-action" onclick="goToCalendar('2025-12-10')">View Details <i data-lucide="arrow-right" width="16"></i></button>
            </div>
        </div>

        <div class="grid-2">
            <!-- Left: Workspaces & Actions -->
            <div class="animate-stagger-2">
                <div class="section-title"><i data-lucide="briefcase" width="18" style="color:var(--accent);"></i> My Workspaces</div>
                
                <div class="team-item" onclick="navigateWithAnimation('dashboard.html?role=Admin')">
                    <div class="team-left">
                        <div class="team-icon" style="color:#e879f9;">ðŸš€</div>
                        <div class="team-info">
                            <h4>Alpha Squad</h4>
                            <span>Admin / Owner</span>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" width="20" color="var(--muted)"></i>
                </div>

                <div class="team-item" onclick="navigateWithAnimation('member_dashboard.html')">
                    <div class="team-left">
                        <div class="team-icon" style="color:#818cf8;">ðŸ’Š</div>
                        <div class="team-info">
                            <h4>MediCare Team</h4>
                            <span>Member</span>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" width="20" color="var(--muted)"></i>
                </div>

                <div class="section-title" style="margin-top:24px;"><i data-lucide="rocket" width="18" style="color:white;"></i> Quick Actions</div>
                
                <div class="action-grid">
                    <div class="action-btn-full" onclick="goToProfile()">
                        <i data-lucide="clock" width="16" style="color:var(--accent-secondary);"></i> Edit My Availability
                    </div>
                </div>
            </div>

            <!-- Right: Activity & Notes -->
            <div class="animate-stagger-3">
                <div class="section-title"><i data-lucide="activity" width="18" style="color:var(--accent);"></i> Updates</div>
                
                <div class="card" style="padding: 20px;">
                    <div class="activity-list">
                        <div class="activity-item">
                            <div class="act-icon"><i data-lucide="users" width="14"></i></div>
                            <div>
                                <div class="act-content"><b>Sarah</b> joined Alpha Squad.</div>
                                <div class="act-time">10 mins ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="act-icon"><i data-lucide="calendar" width="14"></i></div>
                            <div>
                                <div class="act-content">Schedule conflict resolved.</div>
                                <div class="act-time">2 hours ago</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-title"><i data-lucide="sticky-note" width="18" style="color:var(--muted);"></i> Quick Notes</div>
                <div class="card" style="padding:16px;">
                    <div style="display:flex; gap:8px; margin-bottom:12px;">
                        <input type="text" id="noteInput" placeholder="Add reminder..." style="background:rgba(0,0,0,0.3); border:1px solid var(--border); padding:8px; border-radius:8px; width:100%; color:white; font-size:13px;">
                        <button onclick="addNote()" style="background:var(--accent); color:black; border:none; border-radius:8px; width:36px; cursor:pointer; display:flex; align-items:center; justify-content:center;"><i data-lucide="plus" width="16"></i></button>
                    </div>
                    <div id="noteList" style="display:flex; flex-direction:column; gap:8px;">
                        <div style="font-size:13px; padding:8px; background:rgba(255,255,255,0.05); border-radius:6px; color:var(--muted); display:flex; justify-content:space-between; align-items:center;">
                            <span>Submit Q4 Report</span> <i data-lucide="x" width="12" style="cursor:pointer"></i>
                        </div>
                        <div style="font-size:13px; padding:8px; background:rgba(255,255,255,0.05); border-radius:6px; color:var(--muted); display:flex; justify-content:space-between; align-items:center;">
                            <span>Prepare Materials</span> <i data-lucide="x" width="12" style="cursor:pointer"></i>
                        </div>
                        <div style="font-size:13px; padding:8px; background:rgba(255,255,255,0.05); border-radius:6px; color:var(--muted); display:flex; justify-content:space-between; align-items:center;">
                            <span>Pass Requirements</span> <i data-lucide="x" width="12" style="cursor:pointer"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. CALENDAR SECTION -->
    <div id="calendar" class="section-content">
        <div class="card animate-stagger-1">
            <div class="calendar-header">
                <div style="font-size: 20px; font-weight: 800; color: white;" id="calMonthYear"></div>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-outline" style="padding: 6px 10px;" onclick="changeMonth(-1)"><i data-lucide="chevron-left" width="16"></i></button>
                    <button class="btn btn-outline" style="padding: 6px 10px;" onclick="changeMonth(1)"><i data-lucide="chevron-right" width="16"></i></button>
                </div>
             </div>
             
             <!-- Days Header -->
             <div class="calendar-grid" style="margin-bottom:8px;">
                <div class="cal-day-name">Sun</div><div class="cal-day-name">Mon</div><div class="cal-day-name">Tue</div><div class="cal-day-name">Wed</div><div class="cal-day-name">Thu</div><div class="cal-day-name">Fri</div><div class="cal-day-name">Sat</div>
             </div>

             <div class="calendar-grid" id="calendarGrid">
                <!-- JS Injected -->
             </div>
             
             <!-- Legend -->
             <div style="display:flex; gap:16px; justify-content:center; margin-top:16px; flex-wrap:wrap;">
                <div style="display:flex; align-items:center; gap:6px; font-size:11px; color:var(--muted);"><span style="width:10px; height:10px; background:rgba(232, 121, 249, 0.4); border-radius:2px;"></span> Alpha Squad</div>
                <div style="display:flex; align-items:center; gap:6px; font-size:11px; color:var(--muted);"><span style="width:10px; height:10px; background:rgba(129, 140, 248, 0.4); border-radius:2px;"></span> Medicare</div>
                <div style="display:flex; align-items:center; gap:6px; font-size:11px; color:var(--muted);"><span style="width:10px; height:10px; background:rgba(74, 222, 128, 0.4); border-radius:2px;"></span> Holiday</div>
             </div>
             
             <div id="dateDetails" style="margin-top: 24px; padding-top:24px; border-top:1px solid var(--border); display:none; animation: slideInUp 0.3s ease;">
                 <h4 style="color:white; font-size:14px; margin-bottom:16px; font-weight:600; display:flex; align-items:center; gap:8px;">
                    <i data-lucide="clock" width="14" color="var(--accent)"></i> Events on <span id="selectedDateText" style="color:var(--accent);"></span>
                </h4>
                 <div id="eventsContainer"></div>
             </div>
        </div>
    </div>

    <!-- 3. PROFILE SECTION -->
    <div id="profile" class="section-content">
        
        <!-- Profile Identity & Customization -->
        <div class="card animate-stagger-1">
            <div class="profile-header">
                <div class="profile-avatar-lg" onclick="document.getElementById('fileInput').click()">
                    <img id="avatarImg" src="" style="display:none; width:100%; height:100%; object-fit:cover;">
                    <span id="avatarInitials">U</span>
                </div>
                <div class="profile-info-edit">
                    <!-- Name & Title -->
                    <div class="profile-field-group">
                        <input type="text" id="userName" class="profile-input title" value="User Name" placeholder="Your Name" oninput="updateGreetingLive(this.value)">
                        <input type="text" id="userTitle" class="profile-input" placeholder="Job Title (e.g. Senior Developer)" style="background:transparent; border:none; padding:0; color:var(--muted); font-size:13px; text-align:inherit;">
                    </div>
                    
                    <!-- Pronouns -->
                    <div style="margin-top:8px; display:flex; gap:12px;">
                        <input type="text" id="userPronouns" class="profile-input" placeholder="Pronouns (e.g. they/them)" style="width: 150px; font-size:12px; padding:6px 10px;">
                    </div>
                    
                    <!-- Details Grid -->
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; width:100%; margin-top:12px;">
                        <div>
                            <label class="profile-label">Email</label>
                            <input type="text" class="profile-input" value="user@example.com" readonly style="opacity:0.7; cursor:not-allowed;">
                        </div>
                        <div>
                            <label class="profile-label">Location</label>
                            <input type="text" id="userLocation" class="profile-input" placeholder="e.g. New York, USA">
                        </div>
                    </div>

                    <!-- Status -->
                    <div style="margin-top:12px;">
                        <label class="profile-label" style="display:block; margin-bottom:4px;">Current Status</label>
                        <button id="statusBtn" class="status-btn active" onclick="toggleStatus()">
                            <span class="dot" style="background:currentColor; width:6px; height:6px;"></span> Active
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="padding-top:16px; border-top:1px solid var(--border);">
                <label class="profile-label">Bio / About</label>
                <textarea id="userBio" class="profile-input" rows="2" placeholder="Share a bit about yourself..." style="resize:none; margin-top:4px;"></textarea>
            </div>

            <!-- FUNCTIONAL SAVE BUTTON -->
            <div style="margin-top:20px; display:flex; justify-content:flex-end;">
                <button class="btn-primary-action" onclick="saveProfile()">
                    <i data-lucide="save" width="16"></i> Save Profile
                </button>
            </div>

            <input type="file" id="fileInput" hidden accept="image/*" onchange="updateAvatar(this)">
        </div>

        <!-- SPLIT-SHIFT AVAILABILITY -->
        <div class="section-title animate-stagger-2"><i data-lucide="clock" width="18" style="color:#ffffff;"></i> Weekly Availability (Split Shifts)</div>
        <div class="card animate-stagger-2" id="availContainerCard">
            <div style="margin-bottom:16px; font-size:13px; color:var(--muted);">
                Set your recurring availability. Times must be sequential.
            </div>
                <div id="availErrorBanner" style="display:none; margin-bottom:12px; padding:10px; border-radius:8px; background:rgba(251,113,133,0.06); color:var(--danger); font-weight:700;">Schedule conflict detected â€” fix overlapping shifts to remove this notice.</div>
            <div class="avail-grid" id="availContainer">
                <!-- JS Generated -->
            </div>
            <!-- FUNCTIONAL SAVE BUTTON -->            <button class="btn-primary-action" style="margin-top:20px; width:fit-content; margin-left:auto; margin-right:auto;" onclick="saveAvailability()">Save Schedule</button>
        </div>

    </div>

</div>

<script>
    lucide.createIcons();

    function showToast(msg) {
        // showToast(msg, type) where type can be 'success' (default) or 'error'
        const t = document.getElementById('toast');
        const icon = t.querySelector('i');
        const text = document.getElementById('toastMsg');
        let type = 'success';
        // allow caller to pass type using a delimiter '||' in message (backwards compat)
        if(typeof msg === 'object') {
            type = msg.type || 'success';
            text.innerText = msg.text || '';
        } else if(typeof msg === 'string' && msg.includes('||')) {
            const parts = msg.split('||');
            text.innerText = parts[0];
            type = parts[1] || 'success';
        } else {
            text.innerText = msg;
        }

        if(type === 'error') {
            icon.setAttribute('data-lucide','x-circle');
            icon.style.color = 'var(--danger)';
            t.style.borderColor = 'var(--danger)';
        } else {
            icon.setAttribute('data-lucide','check-circle');
            icon.style.color = 'var(--success)';
            t.style.borderColor = 'var(--accent)';
        }
        lucide.createIcons();
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    // --- Loading & Navigation Animation ---
    function navigateWithAnimation(targetUrl) {
        const overlay = document.getElementById('loadingOverlay');
        const fill = document.querySelector('.loader-box-fill');
        
        // Reset animation
        fill.style.animation = 'none';
        fill.offsetHeight; /* trigger reflow */
        fill.style.animation = 'fillBox 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards';
        
        overlay.style.display = 'flex';
        
        // Actually navigate after delay
        setTimeout(() => {
            if(targetUrl.includes('.html')) {
                // In a real environment, this line handles navigation:
                window.location.href = targetUrl;
            }
        }, 1200);
    }

    // --- Tab Switching ---
    function switchTab(tabId, btn) {
        document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        if(btn) btn.classList.add('active');
    }

    function goToCalendar(targetDateStr) {
        const calBtn = document.querySelectorAll('.tab-btn')[1]; 
        switchTab('calendar', calBtn);
        
        if(targetDateStr) {
            const dateObj = new Date(targetDateStr);
            currYear = dateObj.getFullYear();
            currMonth = dateObj.getMonth(); // 0-indexed
            
            // Render specific month
            renderCalendar();
            
            // Trigger detail view for the specific day
            setTimeout(() => {
                const day = dateObj.getDate(); 
                showEventDetails(targetDateStr, day);
                // Highlight the day visually
                document.querySelectorAll('.cal-date').forEach(el => {
                     // Check if this element represents the day. 
                     // InnerHTML contains span with number.
                     if(el.querySelector('span').innerText == day) {
                         el.style.borderColor = 'white';
                         el.style.boxShadow = '0 0 15px rgba(255,255,255,0.4)';
                     }
                });
            }, 100);
        } else {
            // Reset to today
            currMonth = new Date().getMonth();
            currYear = new Date().getFullYear();
            renderCalendar();
        }
    }

    function goToProfile() {
        const profBtn = document.querySelectorAll('.tab-btn')[2];
        switchTab('profile', profBtn);
        setTimeout(() => {
            document.getElementById('availContainerCard').scrollIntoView({behavior: 'smooth'});
        }, 100);
    }

    // --- Date Display ---
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('en-US', options);

    // --- Profile Logic (With Save) ---
    // Load Saved Data
    const savedProfile = JSON.parse(localStorage.getItem('sa_profile') || '{}');
    if(savedProfile.name) {
        document.getElementById('userName').value = savedProfile.name;
        document.getElementById('avatarInitials').innerText = savedProfile.name.charAt(0).toUpperCase();
        updateGreeting(savedProfile.name);
    } else {
        updateGreeting('User');
    }
    if(savedProfile.title) document.getElementById('userTitle').value = savedProfile.title;
    if(savedProfile.pronouns) document.getElementById('userPronouns').value = savedProfile.pronouns;
    if(savedProfile.location) document.getElementById('userLocation').value = savedProfile.location;
    if(savedProfile.bio) document.getElementById('userBio').value = savedProfile.bio;

    function saveProfile() {
        const profileData = {
            name: document.getElementById('userName').value,
            title: document.getElementById('userTitle').value,
            pronouns: document.getElementById('userPronouns').value,
            location: document.getElementById('userLocation').value,
            bio: document.getElementById('userBio').value
        };
        localStorage.setItem('sa_profile', JSON.stringify(profileData));
        localStorage.setItem('sa_username', profileData.name); 
        
        updateGreeting(profileData.name);
        showToast('Profile Saved Successfully');
    }

    // LIVE TYPING UPDATE
    function updateGreetingLive(val) {
        if(!val) val = "User";
        updateGreeting(val);
        document.getElementById('avatarInitials').innerText = val.charAt(0).toUpperCase();
    }

    function updateGreeting(name) {
        const hour = new Date().getHours();
        let timeGreet = 'Good morning';
        if(hour >= 12) timeGreet = 'Good afternoon';
        if(hour >= 18) timeGreet = 'Good evening';
        // Handle name
        const display = name ? name.split(' ')[0] : 'User';
        document.getElementById('welcomeMsg').innerText = `${timeGreet}, ${display}`;
        // Initials logic if not called live
        if(name && !document.getElementById('avatarInitials').innerText) {
             document.getElementById('avatarInitials').innerText = name.charAt(0).toUpperCase();
        }
    }

    function updateAvatar(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarImg').src = e.target.result;
                document.getElementById('avatarImg').style.display = 'block';
                document.getElementById('avatarInitials').style.display = 'none';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- Status Toggle Logic ---
    const statuses = ['active', 'busy', 'offline'];
    let currentStatusIdx = 0;
    function toggleStatus() {
        currentStatusIdx = (currentStatusIdx + 1) % statuses.length;
        const s = statuses[currentStatusIdx];
        const btn = document.getElementById('statusBtn');
        btn.className = 'status-btn';
        if(s === 'active') {
            btn.classList.add('active');
            btn.innerHTML = `<span class="dot" style="background:currentColor; width:6px; height:6px;"></span> Active`;
        } else if (s === 'busy') {
            btn.classList.add('busy');
            btn.innerHTML = `<span class="dot" style="background:currentColor; width:6px; height:6px;"></span> Busy`;
        } else {
            btn.classList.add('offline');
            btn.innerHTML = `<span class="dot" style="background:currentColor; width:6px; height:6px;"></span> Offline`;
        }
    }

    // --- Quick Notes ---
    function addNote() {
        const val = document.getElementById('noteInput').value;
        if(!val) return;
        const div = document.createElement('div');
        div.style.cssText = "font-size:13px; padding:8px; background:rgba(255,255,255,0.05); border-radius:6px; color:var(--muted); display:flex; justify-content:space-between; align-items:center; animation: fadeIn 0.3s ease;";
        div.innerHTML = `<span>${val}</span> <i data-lucide="x" width="12" style="cursor:pointer" onclick="this.parentElement.remove()"></i>`;
        document.getElementById('noteList').prepend(div);
        document.getElementById('noteInput').value = '';
        lucide.createIcons();
    }

    // --- FIXED SPLIT SHIFT AVAILABILITY LOGIC ---
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const availContainer = document.getElementById('availContainer');
    
    // Load Availability from local or default
    // Load Availability
    days.forEach(day => {
        const dayShort = day.substring(0,3);
        const div = document.createElement('div');
        div.className = 'avail-row';
        div.innerHTML = `
            <div class="avail-day" style="align-self: center; padding-top: 0;">${dayShort}</div>
            
            <div class="avail-right-col">
                <div class="interval-list" id="intervals-${dayShort}">
                    <div class="interval-group" style="display: flex; align-items: center; gap: 8px;">
                        <input type="time" class="avail-input" value="09:00">
                        <span style="color:var(--muted)">-</span>
                        <input type="time" class="avail-input" value="17:00">
                        <div class="error-icon">âœ–</div>
                    </div>
                </div>

                <div class="btn-add-row" onclick="addInterval('${dayShort}')">
                    <i data-lucide="plus" width="12"></i> Shift
                </div>
            </div>
        `;
        availContainer.appendChild(div);
    });

    window.addInterval = function(dayShort) {
        const container = document.getElementById(`intervals-${dayShort}`);
        const group = document.createElement('div');
        group.className = 'interval-group animate-pop';
        group.innerHTML = `
            <input type="time" class="avail-input">
            <span style="color:var(--muted)">-</span>
            <input type="time" class="avail-input">
            <select class="shift-type" style="height:34px; border-radius:8px;">
                <option value="available">Available</option>
                <option value="busy">Busy/Unavailable</option>
            </select>
            <input type="text" class="shift-label" placeholder="Label (e.g. Clinic)" style="height:34px; border-radius:8px; padding:6px 10px; min-width:140px;">
            <button class="btn-icon-small btn-remove" onclick="removeInterval(this)"><i data-lucide="trash-2" width="14"></i></button>
            <div class="error-icon">âœ–</div>
        `;
        container.appendChild(group);
        // Ensure icons render
        lucide.createIcons();
        // Remove animation helper class after it completes so it can re-animate later
        setTimeout(() => group.classList.remove('animate-pop'), 260);
    }

    // Animate removal to give user feedback before removing DOM node
    function removeInterval(btn) {
        const group = btn.closest('.interval-group');
        if(!group) return;
        group.classList.add('removing');
        // allow animation to play then remove
        setTimeout(() => group.remove(), 250);
    }
    
    // Validation helpers: validate groups in a day for overlaps and input correctness
    function validateDayShort(dayShort) {
        const container = document.getElementById(`intervals-${dayShort}`);
        if(!container) return true;
        const groups = Array.from(container.querySelectorAll('.interval-group'));
        // collect intervals with reference to group
        const intervals = [];
        groups.forEach((g, idx) => {
            const inputs = g.querySelectorAll('.avail-input');
            const start = inputs[0] ? inputs[0].value : '';
            const end = inputs[1] ? inputs[1].value : '';
            intervals.push({start, end, group: g, idx});
            // clear previous state
            g.classList.remove('invalid');
            g.title = '';
        });

        // validate individual groups
        let ok = true;
            intervals.forEach(it => {
            const g = it.group;
            if(!it.start && !it.end) return; // skip empty
            // clear inline message first
            const prevInline = g.querySelector('.inline-error');
            if(prevInline) prevInline.remove();
            if(!it.start || !it.end) {
                g.classList.add('invalid'); g.title = 'Incomplete time'; ok = false; 
                const node = document.createElement('div'); node.className = 'inline-error'; node.innerText = 'Incomplete time â€” fill both start & end'; g.appendChild(node);
                return;
            }
            if(it.start >= it.end) { g.classList.add('invalid'); g.title = 'Start must be before end'; ok = false; 
                const node = document.createElement('div'); node.className = 'inline-error'; node.innerText = 'Start must be before end'; g.appendChild(node);
                return; }
        });

        // check overlaps (among non-empty groups)
        const filled = intervals.filter(it => it.start && it.end).map(it => ({start: it.start, end: it.end, group: it.group}));
        // sort by start
        filled.sort((a,b) => a.start.localeCompare(b.start));
        for(let i=1;i<filled.length;i++){
                if(filled[i].start < filled[i-1].end) {
                filled[i].group.classList.add('invalid');
                filled[i-1].group.classList.add('invalid');
                filled[i].group.title = 'Overlaps previous shift';
                filled[i-1].group.title = 'Overlaps next shift';
                ok = false;
                // add inline messages (avoid duplicating)
                if(!filled[i-1].group.querySelector('.inline-error')) {
                    const n = document.createElement('div'); n.className = 'inline-error'; n.innerText = 'Overlaps next shift â€” adjust times'; filled[i-1].group.appendChild(n);
                }
                if(!filled[i].group.querySelector('.inline-error')) {
                    const n2 = document.createElement('div'); n2.className = 'inline-error'; n2.innerText = 'Overlaps previous shift â€” adjust times'; filled[i].group.appendChild(n2);
                }
            }
        }

        // If any group invalid, ensure Save button disabled visually
        const anyInvalid = container.querySelectorAll('.interval-group.invalid').length > 0;
        const saveBtn = document.querySelector('#availContainerCard .btn-primary-action');
        if(saveBtn) saveBtn.disabled = anyInvalid;
        // Show persistent banner when any invalid rows exist for the whole availability card
        const banner = document.getElementById('availErrorBanner');
        if(banner) {
            if(anyInvalid) {
                banner.style.display = 'block';
                banner.innerText = 'Schedule conflict detected â€” fix overlapping shifts to remove this notice.';
            } else {
                banner.style.display = 'none';
            }
        }
        return ok;
    }

    // Delegated input handler to validate as user types/selects
    availContainer.addEventListener('input', (e) => {
        const rootGroup = e.target.closest('.interval-list');
        if(!rootGroup) return;
        // extract dayShort from parent id 'intervals-XXX'
        const id = rootGroup.id || '';
        const m = id.match(/^intervals-(\w{3})/);
        if(m) validateDayShort(m[1]);
    });
    window.addEventListener('DOMContentLoaded', () => {
        // 1. Check if user is logged in
        const token = localStorage.getItem('token');
        const storedName = localStorage.getItem('sa_username');

        // If no token, kick them back to login
        if (!token && !storedName) {
            window.location.href = 'login.html';
            return;
        }

        // 2. Date
        const dateOptions = { weekday: 'long', month: 'long', day: 'numeric' };
        document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('en-US', dateOptions);

        // 3. User Info
        const displayName = storedName || "User";
        document.getElementById('greetingName').innerText = displayName.split(' ')[0];
        document.getElementById('userName').value = displayName;
        document.getElementById('avatarInitials').innerText = displayName.charAt(0).toUpperCase();
        // Populate availability from storage (if present)
        loadAvailability();
        // Validate each weekday after loading so any issues are shown immediately
        ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(s => validateDayShort(s));

        // If user just registered, handle based on flag
        const fromRegister = localStorage.getItem('sa_from_register');
        if(fromRegister) {
            localStorage.removeItem('sa_from_register');
            if(fromRegister === 'yes') {
                // Switch to profile tab and scroll to availability
                const profBtn = document.querySelectorAll('.tab-btn')[2];
                switchTab('profile', profBtn);
                setTimeout(() => {
                    document.getElementById('availContainerCard').scrollIntoView({behavior: 'smooth'});
                    // add a brief highlight
                    const c = document.getElementById('availContainerCard');
                    c.style.boxShadow = '0 12px 40px rgba(232,121,249,0.18)';
                    setTimeout(()=> c.style.boxShadow = '', 2000);
                }, 500);
                showToast('Welcome! Set up your weekly availability.');
            } else {
                // Old behavior for other flags
                showToast('Welcome! Finish setting up your schedule.');
                setTimeout(() => {
                    document.getElementById('availContainerCard').scrollIntoView({behavior:'smooth'});
                    // add a brief highlight
                    const c = document.getElementById('availContainerCard');
                    c.style.boxShadow = '0 12px 40px rgba(232,121,249,0.18)';
                    setTimeout(()=> c.style.boxShadow = '', 2000);
                }, 500);
            }
        }
    });
    
    // Smart Save Logic for Availability
    function saveAvailability() {
        // Prevent saving while there are inline validation errors
        if(document.querySelectorAll('.interval-group.invalid').length > 0) {
            showToast({type:'error', text: 'Fix highlighted shifts before saving.'});
            return;
        }
        // Build availability structure with label and type
        const availability = {};
        days.forEach(day => availability[day.substring(0,3)] = []);

        let valid = true;
        let validationError = '';

        days.forEach(day => {
            const short = day.substring(0,3);
            const container = document.getElementById(`intervals-${short}`);
            const groups = Array.from(container.querySelectorAll('.interval-group'));
            const intervals = [];

            groups.forEach((g, idx) => {
                const inputs = g.querySelectorAll('.avail-input');
                const start = inputs[0] ? inputs[0].value : '';
                const end = inputs[1] ? inputs[1].value : '';
                const typeEl = g.querySelector('.shift-type');
                const labelEl = g.querySelector('.shift-label');
                const type = typeEl ? typeEl.value : 'available';
                const label = labelEl ? labelEl.value.trim() : '';

                if(!start && !end) return; // allow empty row
                if(!start || !end) {
                    valid = false; validationError = `${day}: incomplete time on shift ${idx+1}`; return;
                }
                if(start >= end) { valid = false; validationError = `${day}: shift ${idx+1} start must be before end`; return; }
                if(type === 'busy' && !label) { valid = false; validationError = `${day}: missing label for shift ${idx+1}`; return; }

                intervals.push({start,end,type,label});
            });

            // sort and check overlaps
            intervals.sort((a,b)=> a.start.localeCompare(b.start));
            for(let i=1;i<intervals.length;i++){
                if(intervals[i].start < intervals[i-1].end) { valid = false; validationError = `${day}: shift ${i+1} overlaps previous shift`; break; }
            }

            availability[short] = intervals;
        });

        if(!valid) { showToast({type:'error', text: validationError || 'Validation failed'}); return; }

        // Use shared helper to validate and save if available
        if(window.Sched && window.Sched.validateAvailability) {
            const v = window.Sched.validateAvailability(availability);
            if(!v.ok) { showToast({type:'error', text: v.error}); return; }
            window.Sched.saveAvailability(availability);
        } else {
            localStorage.setItem('sa_availability', JSON.stringify(availability));
            localStorage.setItem('sa_avail_updated', Date.now());
        }

        showToast('Schedule Updated!');
    }

    // Load saved availability and populate inputs
    function loadAvailability() {
        const saved = (window.Sched && window.Sched.loadAvailability) ? window.Sched.loadAvailability() : JSON.parse(localStorage.getItem('sa_availability') || '{}');
        days.forEach(day => {
            const short = day.substring(0,3);
            const container = document.getElementById(`intervals-${short}`);
            // Clear existing groups
            container.innerHTML = '';
            const intervals = saved[short] || [];

            if(intervals.length === 0) {
                // keep one empty default row for convenience
                const group = document.createElement('div');
                group.className = 'interval-group';
                group.innerHTML = `
                    <input type="time" class="avail-input" value="09:00">
                    <span style="color:var(--muted)">-</span>
                    <input type="time" class="avail-input" value="17:00">
                    <select class="shift-type" style="height:34px; border-radius:8px;">
                        <option value="available">Available</option>
                        <option value="busy">Busy/Unavailable</option>
                    </select>
                    <input type="text" class="shift-label" placeholder="Label (e.g. Clinic)" style="height:34px; border-radius:8px; padding:6px 10px; min-width:140px;">
                    <button class="btn-icon-small btn-remove" onclick="removeInterval(this)"><i data-lucide="trash-2" width="14"></i></button>
                    <div class="error-icon">âœ–</div>
                `;
                container.appendChild(group);
            } else {
                intervals.forEach(it => {
                    const group = document.createElement('div');
                    group.className = 'interval-group';
                    group.innerHTML = `
                        <input type="time" class="avail-input" value="${it.start}">
                        <span style="color:var(--muted)">-</span>
                        <input type="time" class="avail-input" value="${it.end}">
                        <select class="shift-type" style="height:34px; border-radius:8px;">
                            <option value="available" ${it.type==='available'?'selected':''}>Available</option>
                            <option value="busy" ${it.type==='busy'?'selected':''}>Busy/Unavailable</option>
                        </select>
                        <input type="text" class="shift-label" placeholder="Label (e.g. Clinic)" value="${(it.label||'')}">
                        <button class="btn-icon-small btn-remove" onclick="removeInterval(this)"><i data-lucide="trash-2" width="14"></i></button>
                        <div class="error-icon">âœ–</div>
                    `;
                    container.appendChild(group);
                });
            }
        });
        lucide.createIcons();
    }

    // --- Full Calendar Logic & Mock Events ---
    let currMonth = new Date().getMonth();
    let currYear = new Date().getFullYear();

    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    
    // UPDATED: Events DB with Team Types
    // Types: 'alpha', 'medicare', 'holiday'
    const EVENTS_DB = {
        // --- Week 1: Early December ---
    // ================= 2025 EVENTS =================

    // --- Q1 - Q3 2025 (Single events) ---
    "2025-01-01": [{title: 'New Year Day', time: 'All Day', location: '-', color: 'green', desc: 'Public Holiday', team: 'holiday'}],
    "2025-02-14": [{title: 'Valentine Lunch', time: '12:00 PM', location: 'Cafeteria', color: 'yellow', desc: 'Social', team: 'social'}],
    "2025-03-15": [{title: 'Medicare Audit', time: '02:00 PM', location: 'Room 202', color: 'blue', desc: 'Compliance check', team: 'medicare'}],
    "2025-04-03": [{title: 'ðŸŽ‚ User Birthday', time: 'All Day', location: '-', color: 'gold', desc: 'Happy Birthday!', team: 'personal'}],
    "2025-05-20": [{title: 'Alpha Design Sprint', time: '01:00 PM', location: 'Lab', color: 'purple', desc: 'UI Refresh', team: 'alpha'}],
    "2025-07-04": [{title: 'Independence Day', time: 'All Day', location: '-', color: 'green', desc: 'Holiday', team: 'holiday'}],
    "2025-08-15": [{title: 'Summer Outing', time: 'All Day', location: 'Beach', color: 'yellow', desc: 'Team Building', team: 'social'}],
    "2025-09-08": [{title: 'Alpha Code Freeze', time: '05:00 PM', location: 'Server Room', color: 'purple', desc: 'v1.5 Prep', team: 'alpha'}],
    "2025-10-31": [{title: 'Halloween', time: '04:00 PM', location: 'Lobby', color: 'yellow', desc: 'Costume Party', team: 'social'}],
    "2025-11-27": [{title: 'Thanksgiving', time: 'All Day', location: '-', color: 'green', desc: 'Holiday', team: 'holiday'}],
    
    // --- DECEMBER 2025 ---
    "2025-12-05": [{title: 'Team Sync', time: '10:00 AM - 11:00 AM', location: 'Zoom', color: 'blue', desc: 'Sync up', team: 'medicare'}],
    "2025-12-10": [{title: 'Client Demo Review', time: '02:00 PM - 03:30 PM', location: 'Alpha', color: 'purple', desc: 'Reviewing progress', team: 'alpha'}],
    "2025-12-13": [{title: 'Reading', time: '10:00 AM - 11:00 AM', location: 'Zoom', color: 'blue', desc: 'Sync up', team: 'medicare'}],
    "2025-12-24": [{title: 'Christmas Eve', time: 'Half Day', location: '-', color: 'green', desc: 'Office closes 12pm', team: 'holiday'}],
    
    // *** STACKED DATE: December 25, 2025 ***
    "2025-12-25": [
        {title: 'Christmas Day', time: 'All Day', location: '-', color: 'green', desc: 'Public Holiday', team: 'holiday'}],
     "2025-12-16": [   {title: 'Urgent Server Patch', time: '08:00 AM - 09:00 AM', location: 'Remote', color: 'purple', desc: 'Alpha Critical Fix', team: 'alpha'}],
     "2025-12-15": [   {title: 'Medicare Auto-Scale', time: '10:00 PM - 11:00 PM', location: 'Server', color: 'blue', desc: 'Automated Job', team: 'medicare'}
    ],

    "2025-12-31": [{title: 'New Year Eve', time: 'Party @ 8PM', location: 'Rooftop', color: 'purple', desc: 'Countdown party', team: 'alpha'}],


    // ================= 2026 EVENTS =================

    // --- Q1 - Q3 2026 (Single events) ---
    "2026-01-01": [{title: 'New Year Day', time: 'All Day', location: '-', color: 'green', desc: 'Holiday', team: 'holiday'}],
    "2026-02-14": [{title: 'Valentineâ€™s', time: 'All Day', location: '-', color: 'green', desc: 'Observance', team: 'holiday'}],
    "2026-04-03": [{title: 'ðŸŽ‚ User Birthday', time: 'All Day', location: '-', color: 'gold', desc: 'Happy Birthday!', team: 'personal'}],
    "2026-05-15": [{title: 'Alpha Architecture', time: '02:00 PM', location: 'Room 304', color: 'purple', desc: 'System Review', team: 'alpha'}],
    "2026-06-20": [{title: 'Medicare Training', time: '10:00 AM', location: 'Zoom', color: 'blue', desc: 'Staff Training', team: 'medicare'}],
    "2026-07-04": [{title: 'Independence Day', time: 'All Day', location: '-', color: 'green', desc: 'Holiday', team: 'holiday'}],
    "2026-09-07": [{title: 'Labor Day', time: 'All Day', location: '-', color: 'green', desc: 'Holiday', team: 'holiday'}],
    "2026-11-26": [{title: 'Thanksgiving', time: 'All Day', location: '-', color: 'green', desc: 'Holiday', team: 'holiday'}],
    "2026-12-15": [ {title: 'Database Backup', time: '11:00 PM', location: 'Cloud', color: 'blue', desc: 'Yearly Dump', team: 'medicare'}  ],
    "2026-12-24": [{title: 'Christmas Eve', time: 'Half Day', location: '-', color: 'green', desc: 'Holiday', team: 'holiday'}],
    "2026-12-25": [ {title: 'Christmas Day', time: 'All Day', location: '-', color: 'green', desc: 'Holiday', team: 'holiday'}],
    "2026-12-17": [ {title: 'On-Call Rotation', time: '09:00 AM - 05:00 PM', location: 'Remote', color: 'purple', desc: 'Alpha Support', team: 'alpha'}],
    "2026-12-31": [{title: 'New Year Eve', time: 'Party @ 8PM', location: 'Club', color: 'purple', desc: 'Alpha Party', team: 'alpha'}]
};

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthYearEl = document.getElementById('calMonthYear');
        
        grid.innerHTML = '';
        monthYearEl.innerText = `${months[currMonth]} ${currYear}`;
        
        let firstDay = new Date(currYear, currMonth, 1).getDay(); // 0 = Sun
        let daysInMonth = new Date(currYear, currMonth + 1, 0).getDate();

        // Empty cells
        for(let i=0; i<firstDay; i++) {
            grid.appendChild(document.createElement('div'));
        }

        let today = new Date();
        
        for(let i=1; i<=daysInMonth; i++) {
            let el = document.createElement('div');
            el.className = 'cal-date';
            el.innerHTML = `<span>${i}</span>`;
            
            // Stagger Animation Delay based on index
            el.style.animationDelay = `${i * 0.03}s`;
            el.classList.add('animate-in'); // Add animation class
            
            // Highlight today (December 10, 2025 for demo purposes if contextually required, otherwise system date)
            if(i === 10 && currMonth === 11 && currYear === 2025) {
                el.classList.add('today');
            } else if (i === today.getDate() && currMonth === today.getMonth() && currYear === today.getFullYear()) {
                 el.classList.add('today');
            }

            // Check events (mock DB and personal events)
            let m = currMonth + 1;
            let d = i;
            let key = `${currYear}-${m.toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            // availability indicator for that weekday
            try {
                const weekdayShort = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(currYear, currMonth, i).getDay()];
                const avail = (window.Sched && window.Sched.loadAvailability) ? window.Sched.loadAvailability() : JSON.parse(localStorage.getItem('sa_availability') || '{}');
                const intervalsForDay = (avail && avail[weekdayShort]) ? avail[weekdayShort] : [];
                if(intervalsForDay.length > 0) el.classList.add('has-availability');
                // if all intervals are busy/unavailable mark as blocked
                if(intervalsForDay.length > 0 && intervalsForDay.every(it => it.type === 'busy')) el.classList.add('blocked-day');
            } catch(e){}

            if(EVENTS_DB[key] || (window.Sched && window.Sched.loadPersonalEvents && window.Sched.loadPersonalEvents()[key])) {
                 // Build a combined list of events (mock DB + personal) for gradient
                 const combined = [];
                 let hasAlpha = false, hasMedicare = false, hasHoliday = false;
                 
                 if(EVENTS_DB[key]) {
                     EVENTS_DB[key].forEach(evt => {
                         const team = evt.team || '';
                         combined.push({ source: 'db', title: evt.title || '', team: team, color: evt.color || '' });
                         if(team === 'alpha') hasAlpha = true;
                         else if(team === 'medicare') hasMedicare = true;
                         else if(team === 'holiday') hasHoliday = true;
                     });
                 }
                 const personal = (window.Sched && window.Sched.loadPersonalEvents) ? window.Sched.loadPersonalEvents() : JSON.parse(localStorage.getItem('sa_personal_events') || '{}');
                 if(personal && personal[key]) {
                     personal[key].forEach(pe => {
                         combined.push({ source: 'personal', title: pe.title || '', team: pe.label || 'Personal', color: pe.color || '' });
                     });
                 }

                 if(combined.length > 0) {
                     // Mark day as having events and apply team-based classes
                     el.classList.add('has-events');
                     if(hasAlpha) el.classList.add('event-alpha');
                     if(hasMedicare) el.classList.add('event-medicare');
                     if(hasHoliday) el.classList.add('event-holiday');
                     
                     // Extract unique colors from events for gradient
                     const colors = [];
                     combined.forEach(ev => {
                         let color = ev.color || '';
                         // For personal events, color is already set
                         if(!color || color.trim() === '') {
                             // For mock DB events, use team-based colors
                             if(ev.team === 'alpha') color = '#e879f9';
                             else if(ev.team === 'medicare') color = '#818cf8';
                             else if(ev.team === 'holiday') color = '#4ade80';
                             else if(ev.team === 'social') color = '#facc15';
                             else color = '#818cf8'; // default
                         }
                         color = color.trim();
                         // Add color only if it's different from previous one
                         if(color && (colors.length === 0 || colors[colors.length - 1] !== color)) colors.push(color);
                     });
                     
                     // Create gradient from event colors (show up to 4 colors max)
                     const gradientColors = colors.slice(0, 4);
                     let gradientStr = '';
                     if(gradientColors.length === 1) {
                         gradientStr = `linear-gradient(90deg, ${gradientColors[0]}, ${gradientColors[0]})`;
                     } else if(gradientColors.length === 2) {
                         gradientStr = `linear-gradient(90deg, ${gradientColors[0]}, ${gradientColors[1]})`;
                     } else if(gradientColors.length === 3) {
                         gradientStr = `linear-gradient(90deg, ${gradientColors[0]}, ${gradientColors[1]}, ${gradientColors[2]})`;
                     } else if(gradientColors.length >= 4) {
                         gradientStr = `linear-gradient(90deg, ${gradientColors[0]}, ${gradientColors[1]}, ${gradientColors[2]}, ${gradientColors[3]})`;
                     }
                     
                     if(gradientStr) {
                         el.style.setProperty('--event-gradient', gradientStr);
                     }
                 }
            }

            el.onclick = function() {
                document.querySelectorAll('.cal-date').forEach(d => {
                    d.style.borderColor = 'transparent'; 
                    d.style.boxShadow = 'none';
                });
                // Highlight selection
                this.style.borderColor = 'white';
                this.style.boxShadow = '0 0 15px rgba(255,255,255,0.4)';
                
                showEventDetails(key, i);
            }
            grid.appendChild(el);
        }
    }

    function changeMonth(dir) {
        currMonth += dir;
        if(currMonth < 0) { currMonth = 11; currYear--; }
        if(currMonth > 11) { currMonth = 0; currYear++; }
        renderCalendar();
    }

    function showEventDetails(key, day) {
        const container = document.getElementById('eventsContainer');
        const wrapper = document.getElementById('dateDetails');
        document.getElementById('selectedDateText').innerText = `${months[currMonth].substring(0,3)} ${day}`;
        wrapper.style.display = 'block';
        container.innerHTML = '';
        // Add quick Add Activity button
        const addBtn = document.createElement('div');
        addBtn.style.marginBottom = '12px';
        addBtn.innerHTML = `<button class="btn-primary-action" onclick="openAddEventModal('${key}')">ï¼‹ Add Activity</button>`;
        container.appendChild(addBtn);
        // Show mock events first
        if(EVENTS_DB[key]) {
            EVENTS_DB[key].forEach(evt => {
                // Team Badge
                let teamBadge = '';
                let borderCol = 'var(--success)';
                if(evt.team === 'alpha') { teamBadge = 'Alpha Squad'; borderCol = 'var(--accent)'; }
                else if(evt.team === 'medicare') { teamBadge = 'Medicare'; borderCol = 'var(--accent-secondary)'; }
                else { teamBadge = 'Holiday'; borderCol = 'var(--success)'; }

                container.innerHTML += `
                    <div style="background:rgba(255,255,255,0.05); border-left:4px solid ${borderCol}; border-radius:8px; padding:12px; margin-bottom:8px; animation:slideInUp 0.3s ease;">
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div style="font-weight:700; color:white;">${evt.title}</div>
                            <span style="font-size:10px; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px;">${teamBadge}</span>
                        </div>
                        <div style="font-size:12px; color:var(--muted); margin-top:4px;">${evt.time} <span style="margin:0 4px">â€¢</span> ${evt.location}</div>
                        <div style="font-size:12px; color:rgba(255,255,255,0.4); margin-top:4px;">${evt.desc}</div>
                    </div>
                `;
            });
        }

        // Then show personal events saved by user
        // Also show 'busy' availability intervals for this weekday (from recurring weekly availability)
        try {
            const weekdayShort = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(currYear, currMonth, day).getDay()];
            const avail = (window.Sched && window.Sched.loadAvailability) ? window.Sched.loadAvailability() : JSON.parse(localStorage.getItem('sa_availability') || '{}');
            const intervals = (avail && avail[weekdayShort]) ? avail[weekdayShort] : [];
            intervals.filter(it => it.type === 'busy').forEach((it, idx) => {
                container.innerHTML += `
                    <div style="background:rgba(251,113,133,0.06); border-left:4px solid rgba(251,113,133,0.9); border-radius:8px; padding:12px; margin-bottom:8px;">
                        <div style="font-weight:700; color:white;">Unavailable: ${it.label || 'Busy'}</div>
                        <div style="font-size:12px; color:var(--muted); margin-top:4px;">${it.start} â€¢ ${it.end}</div>
                    </div>
                `;
            });
        } catch(e) {}
        const personal = (window.Sched && window.Sched.loadPersonalEvents) ? window.Sched.loadPersonalEvents() : JSON.parse(localStorage.getItem('sa_personal_events') || '{}');
        if(personal && personal[key]) {
            personal[key].forEach(evt => {
                container.innerHTML += `
                    <div style="background:rgba(255,255,255,0.03); border-left:4px solid var(--accent); border-radius:8px; padding:12px; margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div style="font-weight:700; color:white;">${evt.title}</div>
                            <span style="font-size:10px; background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px;">${evt.label || 'Personal'}</span>
                        </div>
                        <div style="font-size:12px; color:var(--muted); margin-top:4px;">${evt.allDay ? 'All Day' : (evt.start + ' â€¢ ' + evt.end)}</div>
                        <div style="margin-top:6px; display:flex; gap:8px;">
                            <button class="btn-primary-action" onclick="editPersonalEvent('${key}','${evt.id}')">Edit</button>
                            <button class="btn-primary-action" style="background:rgba(251,113,133,0.9);" onclick="deletePersonalEvent('${key}','${evt.id}')">Delete</button>
                        </div>
                    </div>
                `;
            });
        }

        // If nothing was added to container, show placeholder
        if(!container.innerHTML || container.innerHTML.trim() === '') {
            container.innerHTML = `<div style="color:var(--muted); font-size:13px; font-style:italic;">No events scheduled for this day.</div>`;
        }
    }

    // Init
    renderCalendar();

    // PERSONAL EVENT MODAL HANDLERS
    function initTimePickerScrolls() {
        // Helper to populate time picker scroll
        function populateTimePicker(scrollId, maxValue) {
            const scroll = document.getElementById(scrollId);
            scroll.innerHTML = '';
            for(let i = 0; i < maxValue; i++) {
                const item = document.createElement('div');
                item.className = 'time-picker-item';
                item.textContent = String(i).padStart(2, '0');
                item.addEventListener('click', function() {
                    scroll.querySelectorAll('.time-picker-item').forEach(el => el.classList.remove('selected'));
                    this.classList.add('selected');
                    // Auto-scroll to center
                    const itemIndex = Array.from(scroll.children).indexOf(this);
                    scroll.scrollTop = itemIndex * 32 - 44;
                });
                scroll.appendChild(item);
            }
        }
        
        populateTimePicker('pe-start-hour-scroll', 24);
        populateTimePicker('pe-start-min-scroll', 60);
        populateTimePicker('pe-end-hour-scroll', 24);
        populateTimePicker('pe-end-min-scroll', 60);
    }

    function getTimeFromPickers(prefix) {
        const hourScroll = document.getElementById(`pe-${prefix}-hour-scroll`);
        const minScroll = document.getElementById(`pe-${prefix}-min-scroll`);
        const hour = hourScroll.querySelector('.time-picker-item.selected')?.textContent || '00';
        const min = minScroll.querySelector('.time-picker-item.selected')?.textContent || '00';
        return `${hour}:${min}`;
    }

    function setTimeToPickers(prefix, time) {
        const [hour, min] = time.split(':');
        const hourScroll = document.getElementById(`pe-${prefix}-hour-scroll`);
        const minScroll = document.getElementById(`pe-${prefix}-min-scroll`);
        
        // Set hour
        const hourItems = hourScroll.querySelectorAll('.time-picker-item');
        hourItems.forEach(el => el.classList.remove('selected'));
        if(hourItems[parseInt(hour || 0)]) {
            hourItems[parseInt(hour || 0)].classList.add('selected');
            hourScroll.scrollTop = parseInt(hour || 0) * 32 - 44;
        }
        
        // Set min
        const minItems = minScroll.querySelectorAll('.time-picker-item');
        minItems.forEach(el => el.classList.remove('selected'));
        if(minItems[parseInt(min || 0)]) {
            minItems[parseInt(min || 0)].classList.add('selected');
            minScroll.scrollTop = parseInt(min || 0) * 32 - 44;
        }
    }

    function openAddEventModal(dateKey) {
        const modal = document.getElementById('personalEventModal');
        modal.querySelector('#pe-date').value = dateKey;
        
        // Initialize time pickers if not already done
        if(!modal.querySelector('#pe-start-hour-scroll').children.length) {
            initTimePickerScrolls();
        }
        
        modal.classList.add('open');
        // reset form
        modal.querySelector('#pe-title').value = '';
        setTimeToPickers('start', '09:00');
        setTimeToPickers('end', '10:00');
        modal.querySelector('#pe-label').value = '';
        modal.querySelector('#pe-allday').checked = false;
        // reset color to default indigo
        modal.querySelector('#pe-color').value = '#818cf8';
        document.getElementById('pe-color-label').style.background = 'rgba(0,0,0,0.12)';
        document.getElementById('pe-color-label').style.color = 'white';
        document.getElementById('pe-color-label').innerText = '#818CF8';
    }

    function closeAddEventModal() {
        document.getElementById('personalEventModal').classList.remove('open');
    }

    // Update color label when user picks a color
    if(document.getElementById('pe-color')) {
        document.getElementById('pe-color').addEventListener('input', (e) => {
            const hex = e.target.value;
            const label = document.getElementById('pe-color-label');
            label.style.background = `${hex}33`; // semi-transparent
            label.style.color = hex;
            label.innerText = hex.toUpperCase();
        });
    }

    function submitPersonalEvent(e) {
        e.preventDefault();
        const modal = document.getElementById('personalEventModal');
        const dateKey = modal.querySelector('#pe-date').value;
        const title = modal.querySelector('#pe-title').value.trim();
        const start = getTimeFromPickers('start');
        const end = getTimeFromPickers('end');
        const label = modal.querySelector('#pe-label').value.trim();
        const allDay = modal.querySelector('#pe-allday').checked;
        const color = modal.querySelector('#pe-color').value;

        if(!title) { showToast('Please enter a title'); return; }
        if(!allDay && (!start || !end)) { showToast('Please provide start and end time'); return; }
        if(!allDay && start >= end) { showToast('Start must be before end'); return; }

        const eventObj = { title, start, end, label, allDay, color };
        console.log('submitPersonalEvent:', dateKey, eventObj);

        // Check for overlaps with existing personal events on that date
        const existingPersonal = (window.Sched && window.Sched.loadPersonalEvents) ? window.Sched.loadPersonalEvents() : JSON.parse(localStorage.getItem('sa_personal_events') || '{}');
        const list = existingPersonal[dateKey] || [];
        console.log('Existing events on date:', list);

        function overlaps(aStart, aEnd, bStart, bEnd) {
            // if any are all day, consider overlap
            if(!aStart || !aEnd || !bStart || !bEnd) return true;
            return !(aEnd <= bStart || aStart >= bEnd);
        }

        let conflictFound = false;
        // check personal events
        if(!eventObj.allDay) {
            for(const ex of list) {
                if(ex.allDay) { conflictFound = true; break; }
                if(overlaps(eventObj.start, eventObj.end, ex.start, ex.end)) { conflictFound = true; break; }
            }
        } else {
            if(list.length > 0) conflictFound = true;
        }

        console.log('Conflict found with personal events:', conflictFound);

        // check against recurring busy intervals for that weekday
        try {
            const parsed = dateKey.split('-');
            const yyyy = parseInt(parsed[0],10), mm = parseInt(parsed[1],10)-1, dd = parseInt(parsed[2],10);
            const weekdayShort = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(yyyy, mm, dd).getDay()];
            const avail = (window.Sched && window.Sched.loadAvailability) ? window.Sched.loadAvailability() : JSON.parse(localStorage.getItem('sa_availability') || '{}');
            const busyIntervals = (avail && avail[weekdayShort]) ? avail[weekdayShort].filter(it => it.type === 'busy') : [];
            console.log('Busy intervals for', weekdayShort, ':', busyIntervals);
            for(const bi of busyIntervals) {
                if(eventObj.allDay) { conflictFound = true; break; }
                if(overlaps(eventObj.start, eventObj.end, bi.start, bi.end)) { conflictFound = true; break; }
            }
        } catch(err){console.log('Error checking availability:', err);}

        console.log('Final conflict status:', conflictFound);

        if(conflictFound) {
            // show overlap confirmation modal with options
            window._pendingPersonalEvent = { dateKey, eventObj };
            const om = document.getElementById('overlapConfirmModal');
            om.querySelector('#overlapDate').innerText = dateKey;
            om.classList.add('open');
            return;
        }

        // no conflict -> proceed to add
        addPersonalEventNow(dateKey, eventObj);
    }

    function addPersonalEventNow(dateKey, eventObj) {
        console.log('addPersonalEventNow:', dateKey, eventObj);
        if(window.Sched && window.Sched.addPersonalEvent) {
            const added = window.Sched.addPersonalEvent(dateKey, eventObj);
            console.log('Added event:', added);
        } else {
            const pe = JSON.parse(localStorage.getItem('sa_personal_events') || '{}');
            if(!pe[dateKey]) pe[dateKey] = [];
            eventObj.id = 'ev_' + Date.now() + '_' + Math.floor(Math.random()*9999);
            pe[dateKey].push(eventObj);
            localStorage.setItem('sa_personal_events', JSON.stringify(pe));
            console.log('Added to localStorage:', pe);
        }

        closeAddEventModal();
        renderCalendar();
        showToast('Event added');
    }

    function confirmAddAnyway() {
        const pending = window._pendingPersonalEvent;
        if(!pending) return;
        if(pending.action === 'edit') {
            // perform edit replacement
            const dateKey = pending.dateKey;
            const ev = pending.eventObj;
            const peAll = (window.Sched && window.Sched.loadPersonalEvents) ? window.Sched.loadPersonalEvents() : JSON.parse(localStorage.getItem('sa_personal_events') || '{}');
            const list = peAll[dateKey] || [];
            const idx = list.findIndex(x => x.id === ev.id);
            if(idx >= 0) list[idx] = ev;
            else list.push(ev);
            peAll[dateKey] = list;
            if(window.Sched && window.Sched.savePersonalEvents) window.Sched.savePersonalEvents(peAll);
            else localStorage.setItem('sa_personal_events', JSON.stringify(peAll));
            window._pendingPersonalEvent = null;
            const om = document.getElementById('overlapConfirmModal'); if(om) om.classList.remove('open');
            closeAddEventModal(); renderCalendar(); showToast('Event updated (forced)');
            return;
        }
        // default -> add
        addPersonalEventNow(pending.dateKey, pending.eventObj);
        window._pendingPersonalEvent = null;
        const om = document.getElementById('overlapConfirmModal'); if(om) om.classList.remove('open');
    }

    function cancelOverlapModal() {
        const om = document.getElementById('overlapConfirmModal');
        if(om) om.classList.remove('open');
        // re-open the add event modal so user can adjust times
        const pending = window._pendingPersonalEvent;
        if(pending) openAddEventModal(pending.dateKey);
    }

    function deletePersonalEvent(key, id) {
        if(window.Sched && window.Sched.removePersonalEvent) {
            window.Sched.removePersonalEvent(key, id);
        } else {
            const pe = JSON.parse(localStorage.getItem('sa_personal_events') || '{}');
            if(pe[key]) pe[key] = pe[key].filter(x => x.id !== id);
            localStorage.setItem('sa_personal_events', JSON.stringify(pe));
        }
        // Re-render calendar and refresh details panel if visible for the same date
        try {
            const parts = key.split('-');
            const y = parseInt(parts[0],10), m = parseInt(parts[1],10)-1, d = parseInt(parts[2],10);
            currYear = y; currMonth = m;
            renderCalendar();
            const wrapper = document.getElementById('dateDetails');
            if(wrapper && wrapper.style.display !== 'none') showEventDetails(key, d);
        } catch(err) { renderCalendar(); }
        showToast('Event deleted');
    }

    function editPersonalEvent(key, id) {
        const pe = (window.Sched && window.Sched.loadPersonalEvents) ? window.Sched.loadPersonalEvents() : JSON.parse(localStorage.getItem('sa_personal_events') || '{}');
        const ev = (pe[key] || []).find(x => x.id === id);
        if(!ev) return;
        const modal = document.getElementById('personalEventModal');
        
        // Initialize time pickers if not already done
        if(!modal.querySelector('#pe-start-hour-scroll').children.length) {
            initTimePickerScrolls();
        }
        
        modal.classList.add('open');
        modal.querySelector('#pe-date').value = key;
        modal.querySelector('#pe-title').value = ev.title || '';
        setTimeToPickers('start', ev.start || '09:00');
        setTimeToPickers('end', ev.end || '10:00');
        modal.querySelector('#pe-label').value = ev.label || '';
        modal.querySelector('#pe-allday').checked = !!ev.allDay;
        // set color if available, otherwise default
        const color = ev.color || '#818cf8';
        modal.querySelector('#pe-color').value = color;
        const label = document.getElementById('pe-color-label');
        label.style.background = `${color}33`;
        label.style.color = color;
        label.innerText = color.toUpperCase();

        // When saving, replace rather than add
        const form = modal.querySelector('form');
        form.onsubmit = function(evSubmit) {
            evSubmit.preventDefault();
            const dateKey = modal.querySelector('#pe-date').value;
            const title = modal.querySelector('#pe-title').value.trim();
            const start = getTimeFromPickers('start');
            const end = getTimeFromPickers('end');
            const label = modal.querySelector('#pe-label').value.trim();
            const allDay = modal.querySelector('#pe-allday').checked;
            const color = modal.querySelector('#pe-color').value;
            if(!title) { showToast('Enter title'); return; }
            if(!allDay && (!start || !end)) { showToast('Enter start/end'); return; }
            if(!allDay && start >= end) { showToast('Start must be before end'); return; }

            // check for overlaps similar to submitPersonalEvent
            const eventObj = { id, title, start, end, label, allDay, color };
            const existingPersonal = (window.Sched && window.Sched.loadPersonalEvents) ? window.Sched.loadPersonalEvents() : JSON.parse(localStorage.getItem('sa_personal_events') || '{}');
            const list = (existingPersonal[dateKey] || []).filter(x => x.id !== id); // exclude self

            function overlaps(aStart, aEnd, bStart, bEnd) {
                if(!aStart || !aEnd || !bStart || !bEnd) return true;
                return !(aEnd <= bStart || aStart >= bEnd);
            }

            let conflictFound = false;
            if(!eventObj.allDay) {
                for(const ex of list) {
                    if(ex.allDay) { conflictFound = true; break; }
                    if(overlaps(eventObj.start, eventObj.end, ex.start, ex.end)) { conflictFound = true; break; }
                }
            } else {
                if(list.length > 0) conflictFound = true;
            }

            // check against recurring busy intervals
            try {
                const parsed = dateKey.split('-');
                const yyyy = parseInt(parsed[0],10), mm = parseInt(parsed[1],10)-1, dd = parseInt(parsed[2],10);
                const weekdayShort = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(yyyy, mm, dd).getDay()];
                const avail = (window.Sched && window.Sched.loadAvailability) ? window.Sched.loadAvailability() : JSON.parse(localStorage.getItem('sa_availability') || '{}');
                const busyIntervals = (avail && avail[weekdayShort]) ? avail[weekdayShort].filter(it => it.type === 'busy') : [];
                for(const bi of busyIntervals) {
                    if(eventObj.allDay) { conflictFound = true; break; }
                    if(overlaps(eventObj.start, eventObj.end, bi.start, bi.end)) { conflictFound = true; break; }
                }
            } catch(err){}

            if(conflictFound) {
                // set pending edit
                window._pendingPersonalEvent = { action: 'edit', dateKey, eventObj };
                const om = document.getElementById('overlapConfirmModal');
                om.querySelector('#overlapDate').innerText = dateKey;
                om.classList.add('open');
                return;
            }

            // update
            const peAll = (window.Sched && window.Sched.loadPersonalEvents) ? window.Sched.loadPersonalEvents() : JSON.parse(localStorage.getItem('sa_personal_events') || '{}');
            const listAll = peAll[dateKey] || [];
            const idx = listAll.findIndex(x => x.id === id);
            if(idx >= 0) {
                listAll[idx] = { id, title, start, end, label, allDay, color };
                peAll[dateKey] = listAll;
                if(window.Sched && window.Sched.savePersonalEvents) window.Sched.savePersonalEvents(peAll);
                else localStorage.setItem('sa_personal_events', JSON.stringify(peAll));
            }
            form.onsubmit = submitPersonalEvent; // restore default handler
            closeAddEventModal(); renderCalendar(); showToast('Event updated');
        }
    }

</script>

    <!-- PERSONAL EVENT MODAL -->
<div id="personalEventModal">
    <div class="personal-modal-box">
        <form onsubmit="submitPersonalEvent(event)">
            <input id="pe-date" type="hidden">
            <div style="font-weight:700; font-size:16px; margin-bottom:8px;">Add Activity</div>
            <input id="pe-title" placeholder="Title" class="modal-input" style="width:100%; margin-bottom:8px;">
            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                <div style="flex: 1;">
                    <label style="font-size: 11px; color: var(--muted); font-weight: 700; margin-bottom: 4px; text-transform: uppercase; display: block;">Start Time</label>
                    <input type="time" id="pe-start-time" class="modal-input" style="width: 100%;">
                </div>
                <div style="color: var(--muted); font-weight: 700;">to</div>
                <div style="flex: 1;">
                    <label style="font-size: 11px; color: var(--muted); font-weight: 700; margin-bottom: 4px; text-transform: uppercase; display: block;">End Time</label>
                    <input type="time" id="pe-end-time" class="modal-input" style="width: 100%;">
                </div>
            </div>
            <input id="pe-label" placeholder="Label (e.g. Clinic)" class="modal-input" style="width:100%; margin-bottom:8px;">
            <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;"><input id="pe-allday" type="checkbox"> All day</label>
            <div style="margin-bottom:8px;">
                <label style="font-size:11px; color:var(--muted); text-transform:uppercase; font-weight:700;">Event Color</label>
                <div style="display:flex; gap:6px; margin-top:4px;">
                    <input id="pe-color" type="color" value="#818cf8" style="width:40px; height:34px; border:1px solid var(--border); border-radius:6px; cursor:pointer;">
                    <span id="pe-color-label" style="flex:1; padding:8px; background:rgba(0,0,0,0.12); border-radius:6px; color:white; font-size:12px; align-self:center;">#818CF8</span>
                </div>
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" class="btn-primary-action" onclick="closeAddEventModal()">Cancel</button>
                <button type="submit" class="btn-primary-action">Save</button>
            </div>
        </form>
    </div>
</div>
<!-- OVERLAP CONFIRMATION MODAL -->
<div id="overlapConfirmModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:21000;">
    <div style="background:rgba(0,0,0,0.9); padding:20px; border-radius:12px; width:420px; box-shadow:0 20px 60px rgba(0,0,0,0.6);">
        <div style="font-weight:800; font-size:16px; color:var(--danger); margin-bottom:8px;">Time Conflict Detected</div>
        <div style="color:var(--muted); margin-bottom:12px;">This activity overlaps an existing event or an unavailable block on <span id="overlapDate" style="color:var(--accent);"></span>. Do you want to add it anyway or change the time?</div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button class="btn-primary-action" onclick="cancelOverlapModal()">Change Time</button>
            <button class="btn-primary-action" style="background:rgba(251,113,133,0.95);" onclick="confirmAddAnyway()">Add Anyway</button>
        </div>
    </div>
</div>
</body>
</html>